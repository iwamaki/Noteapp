---
filename: 20251115_websocket_authentication_vulnerability # "[作成日時]_[issueのタイトル]"
status: new # new | in-progress | blocked | pending-review | done
priority: A:high # A:high | B:medium | C:low
attempt_count: 0 # このissueへの挑戦回数。失敗のたびにインクリメントする
tags: [security, backend, websocket, authentication] # 例: [UI, navigation, bug]
date: 2025/11/15 # issue作成日時
---

## 概要 (Overview)

> WebSocket接続の認証が`clientId`のみに依存しており、サーバー側での検証が行われていません。これにより、第三者がユーザーになりすまして接続できる重大な脆弱性が存在します。このissueは、この脆弱性を修正し、安全なトークンベースの認証メカニズムを実装することを目的とします。

## 背景 (Background)

> `codebase_investigator`によるコードベース全体の調査の結果、WebSocketの認証フローに重大なセキュリティリスクが発見されました。現在の実装では、URLのパスに含まれる`clientId`をバックエンドが無条件に信頼して接続を許可しています。これは不正アクセスのリスクが非常に高く、ユーザーのセッションを保護し、アプリケーション全体の信頼性を確保するために、この認証プロセスの修正は急務です。

## 実装方針 (Implementation Strategy)

> 1.  現在のURLに`clientId`を埋め込む認証方式を廃止します。
> 2.  代わりに、標準的なトークンベースの認証を導入します。フロントエンドは、既存の認証システム（例: `app/auth/authApiClient.ts`）から取得した認証トークンを利用します。
> 3.  フロントエンドは、WebSocket接続を確立した直後に、この認証トークンを含む`auth`メッセージを送信します。
> 4.  バックエンドは、接続時にまず`auth`メッセージを待ち受けます。
> 5.  `auth`メッセージを受信したら、トークンを検証します。検証が成功した場合のみ、その後の通信を許可し、接続を正式に確立します。
> 6.  検証に失敗した場合、またはタイムアウトした場合は、サーバーは接続を切断します。

## 受け入れ条件 (Acceptance Criteria)

> - [ ] WebSocket接続URLに`clientId`が含まれなくなる。
> - [ ] WebSocket接続後、フロントエンドが認証トークンを含む`auth`メッセージを送信する。
> - [ ] バックエンドが`auth`メッセージ内の認証トークンを正しく検証する。
> - [ ] 無効なトークンで接続しようとした場合、バックエンドが接続を拒否・切断する。
> - [ ] 認証が成功したユーザーのみがWebSocket経由で通信を行える。

## 関連ファイル (Related Files)

> - `app/features/chat/services/websocketService.ts` (フロントエンドの接続ロジック)
> - `server/src/main.py` (バックエンドのWebSocketエンドポイント)
> - `server/src/api/websocket.py` (バックエンドの接続管理ロジック)
> - `app/auth/authApiClient.ts` (認証トークン取得の参考)

## 制約条件 (Constraints)

> - 認証処理によるパフォーマンスへの影響を最小限に抑えること。
> - 既存のHTTPリクエストで使用されている認証メカニズムと一貫性のある方法を採用することが望ましい。

## 開発ログ (Development Log)

> このissueに関する作業の履歴を時系列で記録します。
> セッションをまたいで作業する際の引き継ぎ情報となります。

---
### 試行 #1

- **試みたこと:** (未着手)
- **結果:** (未着手)
- **メモ:** (未着手)

---

## AIへの申し送り事項 (Handover to AI)

> - **現在の状況:** 脆弱性の特定と、それに対する修正方針の立案が完了した状態です。
> - **次のアクション:** 上記の「実装方針」と「受け入れ条件」に基づき、脆弱性の修正作業を開始してください。まずはバックエンド側 (`server/src`配下) の認証ロジックの変更から着手することを推奨します。
> - **考慮事項/ヒント:** 修正の中心は`server/src/api/websocket.py`の`ConnectionManager`クラスになります。ここで認証ロジックを組み込む必要があります。フロントエンド側の対応は`app/features/chat/services/websocketService.ts`で行います。
