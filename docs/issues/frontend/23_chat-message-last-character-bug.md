---
title: "[B]_[23]_[チャットメッセージの最後の文字が消えるバグ]"
id: 23
status: in_progress
priority: medium
attempt_count: 0
tags: [UI, chat, bug, rendering]
---

## 概要 (Overview)

> チャットのメッセージにおいて、特に半角数字が末尾にある場合に、最後の文字が表示されない（欠ける）ことがある。これはレンダリングに関するバグと思われる。

## 背景 (Background)

> チャット機能のテスト中に、AIからの返信メッセージの最後の文字がUI上で表示されないバグが発見された。この現象は断続的に発生するが、特に「テストメッセージ1」のように半角数字で終わるメッセージで頻繁に確認される。これによりメッセージが不完全に表示され、ユーザー体験を損なう。
> パディングやゼロ幅スペースの追加といった単純なスタイル調整による初期の修正案は失敗に終わった。これは、`react-native-markdown-display`コンポーネントが特定のプラットフォーム（おそらくAndroid）で抱える、より根深いレンダリング問題であることを示唆している。

## 受け入れ条件 (Acceptance Criteria)

> このissueが「完了」と見なされるための具体的な条件をチェックリスト形式で記述します。
>
> - [ ] 半角数字で終わるものを含め、すべてのチャットメッセージが、最後の文字まで完全に表示されること。
> - [ ] この修正によって、著しいパフォーマンスの低下が引き起こされないこと。
> - [ ] この修正によって、正当なMarkdown形式のコンテンツのレンダリングに悪影響が出ないこと。

## 関連ファイル (Related Files)

> このissueに関連すると思われるファイルやディレクトリのリストです。
>
> - `app/features/chat/components/MessageItem.tsx`
> - `app/features/chat/components/ChatHistory.tsx`
> - `app/design/theme/ThemeContext.tsx`

## 制約条件 (Constraints)

> このissueを解決する際に守るべき制約やルール、考慮すべき技術的・運用的な条件を記述します。
>
> - 変更範囲を最小限に抑えるため、可能であれば`react-native-markdown-display`ライブラリのリプレースは避けること。

## 開発ログ (Development Log)

> このissueに関する作業の履歴を時系列で記録します。

---
### 試行 #1

- **試みたこと:** メッセージ文字列の末尾にゼロ幅スペース (`\u200B`) を追加した。
- **結果:** 失敗。バグは解消されなかった。
- **メモ:** レンダリングの計算を強制的に変更させる試みだったが、効果はなかった。

---
### 試行 #2

- **試みたこと:** メッセージに適用される`baseText`スタイルに`paddingRight: 1`を追加した。
- **結果:** 失敗。バグは解消されなかった。
- **メモ:** テキストコンテナの右側に余白を追加しても、文字の欠けは解決しなかった。

---
### 試行 #3

- **試みたこと:** `<Markdown>`コンポーネントを、追加の`<View>`コンポーネントでラップした。
- **結果:** 失敗。バグは解消されなかった。
- **メモ:** レイアウト階層を追加しても、レンダリング結果に変化はなかった。

---
### 試行 #4

- **試みたこと:** 条件付きレンダリングを実装。メッセージ内容にMarkdown構文が含まれていない場合は、React Native標準の`<Text>`コンポーネントで描画し、Markdown構文が含まれる場合のみ`<Markdown>`コンポーネントを使用する。
- **実装の詳細:**
  - `app/features/chat/utils/markdown.ts`を作成し、`isMarkdown(text: string)`関数を実装
  - `MessageItem.tsx`を修正して、`isMarkdown()`の結果に基づいて`<Text>`または`<Markdown>`コンポーネントを選択的にレンダリング
  - 検出するMarkdown構文: 見出し、リスト、強調、コード、リンク、引用、水平線など
- **結果:** 失敗。実機でテストしたところ、メッセージが全くレンダリングされなくなった。
- **メモ:** 条件付きレンダリング自体は正しく動作したが、`<Text>`コンポーネントに切り替えてもバグは解消されない。変更は元に戻した。

---
### 試行 #5

- **試みたこと:** 試行#4のアプローチを拡張し、全てのメッセージを`<Text>`コンポーネントでレンダリングするよう変更。`<Markdown>`コンポーネントを完全に使用しない実装。
- **実装の詳細:**
  - `MessageItem.tsx`の条件分岐を削除し、全メッセージを`<Text style={StyleSheet.flatten(markdownTextStyle)}>{message.content}</Text>`でレンダリング
  - TypeScriptのビルド確認: エラーなし
- **結果:** 失敗。。
- **メモ:** `<Text>`コンポーネントによるレンダリングそのものに問題があるようだが、原因は不明。変更は元に戻した。

---
### 観察された現象

ユーザーのテストにより、以下の興味深い傾向が発見された：
- **短いテキスト**（1行に収まる）: 最後の文字が消える
  - 例: `"こんにちはこんちにはt'9"`, `"あああああああああああああああああああああああああああああ1"`
- **長いテキスト**（複数行に折り返される）: 最後の文字が正常に表示される
  - 例: 長文メッセージでは最後の文字が欠けない

この観察から、`react-native-markdown-display`の**テキスト折り返し処理時のレンダリングバグ**である可能性が高い。1行に収まる場合、最後の文字の幅計算が誤っている可能性がある。

---

## AIへの申し送り事項 (Handover to AI)

> 次のセッションでAIがこのissueを引き続き担当する際に、何をすべきかを具体的に記述します。
>
> - **現在の状況:** チャットメッセージの最後の文字が欠ける表示バグが発生中。条件付きレンダリングや`<Text>`コンポーネントへの切り替えを試みたが、いずれも失敗。ユーザーテストにより、短いテキスト（1行に収まる）で最後の文字が消え、長いテキスト（複数行に折り返される）では正常に表示されることが判明。
> - **次のアクション:** 以下のアプローチを検討すること：
>   1. **`react-native-markdown-display`ライブラリの設定を調整**: `style`プロパティで`text`要素に`paddingRight`や`minWidth`を設定し、レンダリング領域を確保する。
>   2. **ライブラリのバージョンを変更**: 別バージョンの`react-native-markdown-display`でバグが修正されている可能性を調査。
>   3. **別のMarkdownライブラリに置き換え**: `react-native-markdown-renderer`や`react-native-showdown`など代替ライブラリの使用を検討。
>   4. **カスタムMarkdownレンダラーの実装**: `text_inline`ルールをカスタマイズし、最後の文字に追加のスペースやパディングを設定。
> - **考慮事項/ヒント:**
>   - このバグは`react-native-markdown-display`ライブラリ内部のテキスト折り返し処理に起因する可能性が極めて高い。
>   - 制約条件では「ライブラリのリプレースは避けること」とあるが、他の手段で解決できない場合は、ライブラリの置き換えも検討する必要がある。
>   - Androidプラットフォーム特有の問題である可能性もあるため、プラットフォーム別の対応も視野に入れること。
