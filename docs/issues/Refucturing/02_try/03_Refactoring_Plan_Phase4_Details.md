# リファクタリング計画 - フェーズ4 詳細: 既存コードの調整とクリーンアップ

## 目的
イベント駆動アーキテクチャ（EDA）とコマンドエグゼキュータの導入後、コードベースの整合性を確保し、クリーンアップを行います。このフェーズでは、既存のサービスファイルの調整と、テストによるアプリケーションの健全性の検証に焦点を当てます。

## 範囲

1.  **`app/services/storageService.ts` の調整**:
    *   `Note`インターフェースの定義を削除します。
    *   `Note`型を`../../shared/types/note`からインポートします。
2.  **`app/services/llmService.ts` の調整**:
    *   `LLMError`クラスは`AppError`と統合せず、`LLMService`固有のエラーとして残します。
3.  **テストの実行**:
    *   変更後に既存のテストを実行し、リファクタリングが既存の機能に影響を与えていないことを確認します。
    *   新しいイベント駆動のロジックをカバーするテストを追加することを検討します。

## 詳細な手順

### ステップ1: `app/services/storageService.ts` の調整

*   **アクション1.1: ローカルの `Note` インターフェースを削除する。**
    *   `app/services/storageService.ts` 内の `export interface Note { ... }` 定義ブロック全体を削除します。
*   **アクション1.2: `Note` を `../../shared/types/note` からインポートする。**
    *   `app/services/storageService.ts` のファイルの先頭に以下のインポート文を追加します。
        ```typescript
        import { Note } from '../../shared/types/note';
        ```
    *   `NoteVersion` が既に正しいパスからインポートされていることを確認します。

### ステップ2: `app/services/llmService.ts` の検証

*   **アクション2.1: `LLMError` クラスが分離されたままであることを確認する。**
    *   `app/services/llmService.ts` 内の `LLMError` クラスを確認し、`AppError` と統合されていないことを確認します。このステップでのコード変更は想定されていません。

### ステップ3: テストの実行

*   **アクション3.1: テストコマンドを特定する。**
    *   `package.json` を確認し、適切なテスト実行コマンド（例: `npm test` または `yarn test`）を特定します。
*   **アクション3.2: テストを実行する。**
    *   特定したテストコマンドを実行し、変更が既存の機能に影響を与えていないこと、およびアプリケーション全体の安定性を検証します。

## 期待される効果

*   **型定義の一元化:** `Note` 型の単一のソースを確立し、コードベース全体の整合性を向上させます。
*   **コードのクリーンアップ:** 不要な重複定義を排除し、コードの可読性と保守性を高めます。
*   **安定性の確保:** 既存のテストを実行することで、リファクタリングによる意図しない副作用がないことを確認します。
