**イベント駆動アーキテクチャ導入によるストア間依存解消計画**

**目的:**
アプリケーション内のストア間の直接的な依存関係を解消し、より柔軟で保守しやすい状態管理システムを構築します。これにより、状態変更の予測可能性を高め、デバッグを容易にし、将来的な機能追加や変更への対応力を向上させます。

**主要な変更点:**

*   **イベントバスシステムの導入:** アプリケーション全体でイベントの発行と受付を管理する中央ハブを設けます。
*   **コマンド実行管理システムの導入:** ユーザー操作を「コマンド」として抽象化し、実行とUndo/Redoを管理します。
*   **既存ストアのリファクタリング:** ストア間の直接参照を排除し、イベントを介して連携するように変更します。
*   **ノート操作フックの導入:** 主要な操作を抽象化し、コンポーネントから利用できるカスタムフックを導入します。

**参照ファイル:**

*   `docs/issues/Refucturing/02_try/02_Refactoring.md` (技術的な提案書)

---

## リファクタリング計画と受け入れ条件

各フェーズの完了は、以下に定義される「受け入れ条件」をすべて満たしているかで判断します。

### フェーズ0: 型定義の統一

#### 受け入れ条件
- [ ] `Note` 型の定義が `shared/types/note.ts` に集約されている。
- [ ] アプリケーション内の他ファイル（例: `app/services/storageService.ts`）は、ローカルで `Note` 型を定義せず、`shared/types/note.ts` からインポートして使用している。

### フェーズ1: 共通基盤の構築

#### 受け入れ条件
- [ ] `app/services/eventBus.ts` が実装されており、イベントの受付・発行・キューイング機能が提供されている。
- [ ] `app/services/commandExecutor.ts` が実装されており、コマンドの実行、Undo/Redoの履歴管理機能が提供されている。
- [ ] コマンド（例: `UpdateNoteCommand`）の `undo` 機能は、コマンドが**実行される直前**の状態を復元できることが保証されている。
- [ ] `EventBus` は、イベントハンドラ内で発生したエラーを捕捉し、`error:occurred` イベントを発行する仕組みを持つ。

### フェーズ2: ストアのリファクタリング

#### 受け入れ条件
- [ ] 各ストア（`noteStore`, `noteSelectionStore`, `noteDraftStore`）は、他のストアへの直接的なインポートや参照（`useOtherStore.getState()`など）を持たない。
- [ ] `noteStore` は `note:created`, `note:updated`, `note:deleted` イベントを受け取り、自身の `notes` 配列を正しく更新できる。
- [ ] `noteStore` は `note:selected` イベントを受け取り、自身の `activeNote` 状態を正しく更新できる。
- [ ] `noteDraftStore` は `note:selected` イベントを受け取り、`draftNote` 状態を `activeNote` の内容で初期化できる。
- [ ] `noteSelectionStore` は、一括削除や一括コピーの完了時に `notes:bulk-deleted` や `notes:bulk-copied` イベントを発行する。

### フェーズ3: フック（UIロジック）のリファクタリング

#### 受け入れ条件
- [ ] `useNoteListLogic` や `useNoteEditor` などのUIロジックフックは、ストアのアクションを直接呼び出さない。
- [ ] ノートの作成・更新・削除といった操作は、`useNoteOperations` フックや `commandExecutor` を介して実行され、その結果が `EventBus` を通じて各ストアに伝達される。
- [ ] UIコンポーネントは、リファクタリングされたストアの状態を監視し、イベントを通じて状態が変更された際に正しく再描画される。

### フェーズ4: テストとクリーンアップ

#### 受け入れ条件
- [ ] 既存のユニットテストおよびE2Eテストが、新しいアーキテクチャの下で全てパスする（必要に応じてテスト自体も修正される）。
- [ ] イベント駆動のロジック（例: 特定のイベント発行後にストアの状態が期待通りに変わるか）を検証する新しいテストが追加されている。
- [ ] リファクタリングによって不要になったコード（古いアクション、ヘルパー関数など）が削除されている。

---

**期待される効果:**

*   **疎結合化:** 各モジュールやストアが独立性を保ち、変更が他の部分に与える影響を最小限に抑えます。
*   **予測可能性の向上:** イベントの流れを追うことで、アプリケーションの状態変化をより明確に理解できるようになります。
*   **テスト容易性の向上:** 各コンポーネントやストアを独立してテストしやすくなります。
*   **拡張性の確保:** 新しい機能やストアを追加する際に、既存のコードベースへの影響を最小限に抑え、柔軟な拡張が可能になります。