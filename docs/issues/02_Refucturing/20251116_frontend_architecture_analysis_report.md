# ãƒ•ãƒ­ãƒ³ãƒˆã‚¨ãƒ³ãƒ‰ã‚¢ãƒ¼ã‚­ãƒ†ã‚¯ãƒãƒ£åˆ†æãƒ¬ãƒãƒ¼ãƒˆ

**ä½œæˆæ—¥**: 2025/11/16
**å¯¾è±¡**: Noteapp ãƒ•ãƒ­ãƒ³ãƒˆã‚¨ãƒ³ãƒ‰ (appãƒ•ã‚©ãƒ«ãƒ€)
**èª¿æŸ»æ–¹æ³•**: 2æ®µéšè©³ç´°èª¿æŸ»ï¼ˆç¬¬1æ®µéšï¼šå…¨ä½“åƒæŠŠæ¡ã€ç¬¬2æ®µéšï¼šæ·±æ˜ã‚Šåˆ†æï¼‰

---

## ç›®æ¬¡

1. [ãƒ—ãƒ­ã‚¸ã‚§ã‚¯ãƒˆè¦æ¨¡ã¨æ§‹æˆ](#1-ãƒ—ãƒ­ã‚¸ã‚§ã‚¯ãƒˆè¦æ¨¡ã¨æ§‹æˆ)
2. [ãƒ‡ã‚£ãƒ¬ã‚¯ãƒˆãƒªæ§‹é€ ã®è©³ç´°åˆ†æ](#2-ãƒ‡ã‚£ãƒ¬ã‚¯ãƒˆãƒªæ§‹é€ ã®è©³ç´°åˆ†æ)
3. [çŠ¶æ…‹ç®¡ç†ã®ä½¿ç”¨å®Ÿæ…‹](#3-çŠ¶æ…‹ç®¡ç†ã®ä½¿ç”¨å®Ÿæ…‹)
4. [ä¾å­˜é–¢ä¿‚ã¨ã‚¢ãƒ¼ã‚­ãƒ†ã‚¯ãƒãƒ£ãƒ‘ã‚¿ãƒ¼ãƒ³](#4-ä¾å­˜é–¢ä¿‚ã¨ã‚¢ãƒ¼ã‚­ãƒ†ã‚¯ãƒãƒ£ãƒ‘ã‚¿ãƒ¼ãƒ³)
5. [ã‚¨ãƒ©ãƒ¼ãƒãƒ³ãƒ‰ãƒªãƒ³ã‚°ã®ç¾çŠ¶](#5-ã‚¨ãƒ©ãƒ¼ãƒãƒ³ãƒ‰ãƒªãƒ³ã‚°ã®ç¾çŠ¶)
6. [ãƒ‘ãƒ•ã‚©ãƒ¼ãƒãƒ³ã‚¹ãƒœãƒˆãƒ«ãƒãƒƒã‚¯](#6-ãƒ‘ãƒ•ã‚©ãƒ¼ãƒãƒ³ã‚¹ãƒœãƒˆãƒ«ãƒãƒƒã‚¯)
7. [èª²é¡Œã®å„ªå…ˆé †ä½ä»˜ãåˆ†æ](#7-èª²é¡Œã®å„ªå…ˆé †ä½ä»˜ãåˆ†æ)
8. [æ—¢å­˜ã®ãƒ™ã‚¹ãƒˆãƒ—ãƒ©ã‚¯ãƒ†ã‚£ã‚¹](#8-æ—¢å­˜ã®ãƒ™ã‚¹ãƒˆãƒ—ãƒ©ã‚¯ãƒ†ã‚£ã‚¹)
9. [æ¨å¥¨ã‚¢ãƒ¼ã‚­ãƒ†ã‚¯ãƒãƒ£è©³ç´°](#9-æ¨å¥¨ã‚¢ãƒ¼ã‚­ãƒ†ã‚¯ãƒãƒ£è©³ç´°)
10. [æ®µéšçš„ç§»è¡Œãƒ—ãƒ©ãƒ³è©³ç´°](#10-æ®µéšçš„ç§»è¡Œãƒ—ãƒ©ãƒ³è©³ç´°)

---

## 1. ãƒ—ãƒ­ã‚¸ã‚§ã‚¯ãƒˆè¦æ¨¡ã¨æ§‹æˆ

### 1.1 åŸºæœ¬çµ±è¨ˆ

```
ç·ãƒ•ã‚¡ã‚¤ãƒ«æ•°: 180å€‹ã®TypeScript/TSXãƒ•ã‚¡ã‚¤ãƒ«
ç·ã‚³ãƒ¼ãƒ‰è¡Œæ•°: ç´„24,197è¡Œ
éšå±¤ãƒ¬ãƒ™ãƒ«: 4-5éšå±¤ã®æ·±ã•
```

### 1.2 ãƒ‡ã‚£ãƒ¬ã‚¯ãƒˆãƒªåˆ¥ãƒ•ã‚¡ã‚¤ãƒ«æ•°åˆ†å¸ƒ

| ãƒ‡ã‚£ãƒ¬ã‚¯ãƒˆãƒª | ãƒ•ã‚¡ã‚¤ãƒ«æ•° | å‰²åˆ | ä¸»è¦ãªè²¬å‹™ |
|------------|----------|------|-----------|
| **features/chat** | 58å€‹ | 32% | ãƒãƒ£ãƒƒãƒˆæ©Ÿèƒ½ï¼ˆLLMçµ±åˆï¼‰ |
| **screen** | 53å€‹ | 29% | ç”»é¢ã‚³ãƒ³ãƒãƒ¼ãƒãƒ³ãƒˆ |
| **initialization** | 17å€‹ | 9% | ã‚¢ãƒ—ãƒªåˆæœŸåŒ– |
| **billing** | 13å€‹ | 7% | èª²é‡‘ãƒ»ãƒˆãƒ¼ã‚¯ãƒ³ç®¡ç† |
| **data** | 9å€‹ | 5% | ãƒ‡ãƒ¼ã‚¿ãƒ¬ã‚¤ãƒ¤ãƒ¼ |
| **design** | 5å€‹ | 3% | ãƒ‡ã‚¶ã‚¤ãƒ³ã‚·ã‚¹ãƒ†ãƒ  |
| **components** | 11å€‹ | 6% | å…±æœ‰UI |
| **settings** | 4å€‹ | 2% | è¨­å®šç®¡ç† |
| **ãã®ä»–** | 10å€‹ | 6% | navigation, auth, hooksç­‰ |

### 1.3 ãƒ•ã‚¡ã‚¤ãƒ«ã‚µã‚¤ã‚ºåˆ†å¸ƒ

| ã‚µã‚¤ã‚ºç¯„å›² | ãƒ•ã‚¡ã‚¤ãƒ«æ•° | ç”¨é€” |
|----------|----------|------|
| 1-50è¡Œ | ç´„40å€‹ | å°ã•ãªãƒ¦ãƒ¼ãƒ†ã‚£ãƒªãƒ†ã‚£ã€å‹å®šç¾© |
| 51-100è¡Œ | ç´„60å€‹ | ã‚³ãƒ³ãƒãƒ¼ãƒãƒ³ãƒˆã€ã‚µãƒ¼ãƒ“ã‚¹ |
| 101-200è¡Œ | ç´„50å€‹ | è¤‡é›‘ãªãƒ­ã‚¸ãƒƒã‚¯ã€ã‚¹ãƒˆã‚¢ |
| 201-300è¡Œ | ç´„20å€‹ | å¤§å‹ã‚³ãƒ³ãƒãƒ¼ãƒãƒ³ãƒˆã€ãƒãƒãƒ¼ã‚¸ãƒ£ãƒ¼ |
| **300è¡Œä»¥ä¸Š** | ç´„10å€‹ | æœ€è¤‡é›‘ãªã‚µãƒ¼ãƒ“ã‚¹ |

**ç‰¹ç­†ã™ã¹ãå¤§å‹ãƒ•ã‚¡ã‚¤ãƒ«**:
- `CustomModal.tsx`: **7,698è¡Œ** âš ï¸ å·¨å¤§åŒ–ã®æ‡¸å¿µ
- `FileRepository.ts`: è¤‡æ•°ãƒ¡ã‚½ãƒƒãƒ‰ã®å¤§å‹ãƒªãƒã‚¸ãƒˆãƒª
- `APIService (api.ts)`: 173è¡Œ

---

## 2. ãƒ‡ã‚£ãƒ¬ã‚¯ãƒˆãƒªæ§‹é€ ã®è©³ç´°åˆ†æ

### 2.1 features/chat (58ãƒ•ã‚¡ã‚¤ãƒ«) - ãƒãƒ£ãƒƒãƒˆæ©Ÿèƒ½ã®æ ¸

#### æ§‹é€ 

```
features/chat/
â”œâ”€â”€ llmService/           # LLMçµ±åˆã®æ ¸
â”‚   â”œâ”€â”€ api.ts (173è¡Œ)   # LLM APIã®æŠ½è±¡åŒ–ã‚¤ãƒ³ã‚¿ãƒ¼ãƒ•ã‚§ãƒ¼ã‚¹
â”‚   â”œâ”€â”€ core/            # ConversationHistory, ProviderManager, RequestManager
â”‚   â”œâ”€â”€ services/        # WebSocketService, SummarizationService
â”‚   â”œâ”€â”€ types/           # 9å€‹ã®å‹å®šç¾©ãƒ•ã‚¡ã‚¤ãƒ«
â”‚   â””â”€â”€ utils/           # CommandValidator, ErrorHandler, HttpClientç­‰
â”‚
â”œâ”€â”€ handlers/ (8ãƒ•ã‚¡ã‚¤ãƒ«)  # LLMã‚³ãƒãƒ³ãƒ‰å‡¦ç†
â”‚   â”œâ”€â”€ createFile, deleteFile, renameFile (Flatç‰ˆ)
â”‚   â”œâ”€â”€ editFile, editFileLines
â”‚   â””â”€â”€ fileContent, searchResults
â”‚
â”œâ”€â”€ services/ (6ãƒ•ã‚¡ã‚¤ãƒ«)  # ãƒ“ã‚¸ãƒã‚¹ãƒ­ã‚¸ãƒƒã‚¯å±¤
â”‚   â”œâ”€â”€ chatAttachmentService.ts    # ãƒ•ã‚¡ã‚¤ãƒ«æ·»ä»˜ç®¡ç†
â”‚   â”œâ”€â”€ chatCommandService.ts       # ã‚³ãƒãƒ³ãƒ‰ãƒ‡ã‚£ã‚¹ãƒ‘ãƒƒãƒ
â”‚   â”œâ”€â”€ chatSummarizationService.ts # ä¼šè©±è¦ç´„
â”‚   â”œâ”€â”€ chatTokenService.ts         # ãƒˆãƒ¼ã‚¯ãƒ³ä½¿ç”¨é‡ç®¡ç†
â”‚   â”œâ”€â”€ chatWebSocketManager.ts     # WebSocketç®¡ç†
â”‚   â””â”€â”€ ToolService.ts              # ãƒ„ãƒ¼ãƒ«å®Ÿè¡Œ
â”‚
â”œâ”€â”€ components/ (8ãƒ•ã‚¡ã‚¤ãƒ«) # UIè¦ç´ 
â”‚   â”œâ”€â”€ ChatInputBar, ChatHistory, MessageInput, MessageItem
â”‚   â””â”€â”€ ModelCard, ModelSelectionModal, AttachedFilesList
â”‚
â”œâ”€â”€ store/                # Zustandã‚¹ãƒˆã‚¢
â”‚   â””â”€â”€ chatStore.ts     # messages, isLoading, attachedFiles, tokenUsage
â”‚
â””â”€â”€ index.ts             # ChatServiceã‚·ãƒ³ã‚°ãƒ«ãƒˆãƒ³ã®ã‚¨ã‚¯ã‚¹ãƒãƒ¼ãƒˆ
```

#### è©•ä¾¡

**è‰¯ã„ç‚¹**:
- âœ… FSD (Feature-Sliced Design) ã®åŸºç¤ãŒå®Ÿè£…æ¸ˆã¿
- âœ… ui/model/api å±¤ã®åˆ†é›¢ãŒæ˜ç¢º
- âœ… è²¬å‹™ã®éƒ¨åˆ†çš„åˆ†é›¢ï¼ˆå„ã‚µãƒ¼ãƒ“ã‚¹ãŒç‹¬ç«‹ï¼‰
- âœ… å‹å®šç¾©ãŒ9ãƒ•ã‚¡ã‚¤ãƒ«ã«æ•´ç†ã•ã‚Œã¦ã„ã‚‹

**èª²é¡Œ**:
- âš ï¸ index.ts ã§ã‚·ãƒ³ã‚°ãƒ«ãƒˆãƒ³ãƒ‘ã‚¿ãƒ¼ãƒ³ä½¿ç”¨ï¼ˆãƒ†ã‚¹ãƒˆå›°é›£ï¼‰
- âš ï¸ handlers/ ãŒ8å€‹ã«åˆ†æ•£ï¼ˆä¸€è²«æ€§ã®æ¤œè¨ä½™åœ°ï¼‰

---

### 2.2 screen (53ãƒ•ã‚¡ã‚¤ãƒ«) - ç”»é¢ã‚³ãƒ³ãƒãƒ¼ãƒãƒ³ãƒˆ

#### file-list-flat (25ãƒ•ã‚¡ã‚¤ãƒ«)

```
screen/file-list-flat/
â”œâ”€â”€ context/
â”‚   â”œâ”€â”€ FlatListContext.tsx (852è¡Œ) âš ï¸ è¤‡é›‘
â”‚   â””â”€â”€ flatListReducer.ts
â”‚
â”œâ”€â”€ components/ (9ãƒ•ã‚¡ã‚¤ãƒ«)
â”‚   â”œâ”€â”€ ãƒ¢ãƒ¼ãƒ€ãƒ«: CreateFileModal, RenameFileModal, MoveFileModalç­‰
â”‚   â””â”€â”€ ãƒªã‚¹ãƒˆ: FileListItem, CategorySectionç­‰
â”‚
â”œâ”€â”€ hooks/ (4ãƒ•ã‚¡ã‚¤ãƒ«)
â”‚   â”œâ”€â”€ useFileListHeader.ts
â”‚   â”œâ”€â”€ useRAGSync.ts
â”‚   â”œâ”€â”€ useImportExport.ts
â”‚   â””â”€â”€ useCategoryCollapse.ts
â”‚
â””â”€â”€ application/
    â””â”€â”€ FileListUseCasesFlatãƒ¦ãƒ¼ã‚¹ã‚±ãƒ¼ã‚¹å±¤
```

**è©•ä¾¡**:
- âš ï¸ FlatListContext ãŒ852è¡Œã§è¤‡é›‘ã™ãã‚‹
- âš ï¸ Context API + useReducer ã§çŠ¶æ…‹ç®¡ç†ï¼ˆZustand ã¨ã®æ··åœ¨ï¼‰
- âœ… ãƒ¢ãƒ¼ãƒ€ãƒ«ãŒ9å€‹ã®ã‚³ãƒ³ãƒãƒ¼ãƒãƒ³ãƒˆã«åˆ†é›¢ï¼ˆCustomModalã¨ã®é–¢ä¿‚è¦ç¢ºèªï¼‰

#### file-edit (20ãƒ•ã‚¡ã‚¤ãƒ«)

```
screen/file-edit/
â”œâ”€â”€ stores/
â”‚   â””â”€â”€ useFileEditorStore.ts (Zustandã‚¹ãƒˆã‚¢)
â”‚
â”œâ”€â”€ services/
â”‚   â”œâ”€â”€ FileService.ts
â”‚   â”œâ”€â”€ ValidationService.ts
â”‚   â””â”€â”€ ErrorService.ts
â”‚
â”œâ”€â”€ components/ (11ãƒ•ã‚¡ã‚¤ãƒ«)
â”‚   â”œâ”€â”€ TextEditor, MarkdownPreview, FeatureBar
â”‚   â””â”€â”€ å„ç¨®ãƒ¢ãƒ¼ãƒ€ãƒ«ãƒ»ãƒœã‚¿ãƒ³
â”‚
â””â”€â”€ utils/
    â””â”€â”€ HistoryManager.ts
```

**è©•ä¾¡**:
- âœ… Zustandã‚¹ãƒˆã‚¢ã§çŠ¶æ…‹ç®¡ç†ï¼ˆè‰¯å¥½ï¼‰
- âœ… ã‚µãƒ¼ãƒ“ã‚¹å±¤ã®åˆ†é›¢ï¼ˆè‰¯å¥½ï¼‰
- âš ï¸ HistoryManagerã¨ã‚¹ãƒˆã‚¢ã®çµ±åˆã‚’æ¤œè¨ä½™åœ°

---

### 2.3 initialization (17ãƒ•ã‚¡ã‚¤ãƒ«) - ã‚¢ãƒ—ãƒªåˆæœŸåŒ–

#### æ§‹é€ 

```
initialization/
â”œâ”€â”€ AppInitializer.ts        # ã‚·ãƒ³ã‚°ãƒ«ãƒˆãƒ³ã§åˆæœŸåŒ–ãƒ—ãƒ­ã‚»ã‚¹å…¨ä½“ã‚’åˆ¶å¾¡
â”œâ”€â”€ InitializationStore.ts   # Zustandã§åˆæœŸåŒ–çŠ¶æ…‹ã‚’ç®¡ç†
â””â”€â”€ tasks/ (14ãƒ•ã‚¡ã‚¤ãƒ«)      # åˆæœŸåŒ–ã‚¿ã‚¹ã‚¯
    â”œâ”€â”€ Critical: authenticateDevice, initializeFileSystem, verifyAsyncStorage
    â”œâ”€â”€ Core: loadSettings, loadIconFonts, configureLLMService
    â”œâ”€â”€ Services: initializeWebSocket, configureChatService, initializeBillingService
    â””â”€â”€ Ready: preloadLLMProviders, loadToolDefinitions, restorePendingPurchasesç­‰
```

#### åˆæœŸåŒ–ãƒ•ãƒ­ãƒ¼

```
Stage 1: CRITICAL
â”œâ”€â”€ authenticateDevice
â”œâ”€â”€ initializeFileSystem
â”œâ”€â”€ verifyAsyncStorage
â””â”€â”€ loadSettings

Stage 2: CORE
â”œâ”€â”€ loadIconFonts
â””â”€â”€ configureLLMService

Stage 3: SERVICES
â”œâ”€â”€ initializeWebSocket
â”œâ”€â”€ configureChatService
â”œâ”€â”€ initializeBillingService
â”œâ”€â”€ preloadLLMProviders (â† configureLLMService ã®å¾Œ)
â”œâ”€â”€ loadToolDefinitions
â””â”€â”€ restorePendingPurchases (â† initializeBillingService ã®å¾Œ)

Stage 4: READY
â””â”€â”€ ã‚¢ãƒ—ãƒªã‚±ãƒ¼ã‚·ãƒ§ãƒ³æº–å‚™å®Œäº†
```

**è©•ä¾¡**:
- âœ… ã‚¹ãƒ†ãƒ¼ã‚¸åˆ¥ã®æ˜ç¢ºãªæ§‹é€ 
- âœ… ã‚¿ã‚¹ã‚¯ã®ä¾å­˜é–¢ä¿‚ãŒç®¡ç†ã•ã‚Œã¦ã„ã‚‹
- âš ï¸ 14å€‹ã®ã‚¿ã‚¹ã‚¯ã¯ä¸¦åˆ—å®Ÿè¡Œã®ä½™åœ°ã‚ã‚Šï¼ˆãƒ‘ãƒ•ã‚©ãƒ¼ãƒãƒ³ã‚¹æœ€é©åŒ–ã®æ©Ÿä¼šï¼‰

---

### 2.4 billing (13ãƒ•ã‚¡ã‚¤ãƒ«) - èª²é‡‘ç®¡ç†

```
billing/
â”œâ”€â”€ constants/  # ãƒ¢ãƒ‡ãƒ«ä¾¡æ ¼è¡¨ã€ãƒˆãƒ¼ã‚¯ãƒ³ãƒ‘ãƒƒã‚±ãƒ¼ã‚¸ã€ä¾¡æ ¼è¨­å®š
â”œâ”€â”€ services/   # IAPçµ±åˆã€APIé€šä¿¡ã€è³¼å…¥å¾©å…ƒ
â””â”€â”€ utils/      # ã‚³ã‚¹ãƒˆè¨ˆç®—ã€ãƒˆãƒ¼ã‚¯ãƒ³ãƒãƒ©ãƒ³ã‚¹ã€ãƒ¢ãƒ‡ãƒ«ã‚«ãƒ†ã‚´ãƒªãƒ¼åˆ†é¡
```

**è©•ä¾¡**:
- âœ… ç‹¬ç«‹æ€§ãŒéå¸¸ã«é«˜ã„
- âœ… ä»–ãƒ¢ã‚¸ãƒ¥ãƒ¼ãƒ«ã¨ã®ã‚«ãƒƒãƒ—ãƒªãƒ³ã‚°ãŒå°‘ãªã„
- âœ… è²¬å‹™ãŒæ˜ç¢º

---

### 2.5 data (9ãƒ•ã‚¡ã‚¤ãƒ«) - ãƒ‡ãƒ¼ã‚¿ãƒ¬ã‚¤ãƒ¤ãƒ¼

```
data/
â”œâ”€â”€ core/
â”‚   â”œâ”€â”€ typesFlat.ts      # FileFlat, FileMetadataFlatç­‰ã®ãƒ‰ãƒ¡ã‚¤ãƒ³å‹
â”‚   â””â”€â”€ errors.ts         # FileSystemV2Error, RepositoryError
â”‚
â”œâ”€â”€ repositories/
â”‚   â”œâ”€â”€ fileRepository.ts # CRUDæ“ä½œ (getAll, getById, create, update, delete)
â”‚   â””â”€â”€ storage/          # ãƒ•ã‚¡ã‚¤ãƒ«ã‚·ã‚¹ãƒ†ãƒ ä½å±¤æ“ä½œ
â”‚
â””â”€â”€ services/
    â”œâ”€â”€ categoryGroupingService.ts    # ãƒ•ã‚¡ã‚¤ãƒ«ã‚’ã‚«ãƒ†ã‚´ãƒªãƒ¼ã§ã‚°ãƒ«ãƒ¼ãƒ—åŒ–
    â”œâ”€â”€ categoryOperationsService.ts  # ã‚«ãƒ†ã‚´ãƒªãƒ¼æ“ä½œ
    â””â”€â”€ metadataService.ts            # ãƒ¡ã‚¿ãƒ‡ãƒ¼ã‚¿æ“ä½œ
```

**è©•ä¾¡**:
- âœ… ãƒªãƒã‚¸ãƒˆãƒªãƒ‘ã‚¿ãƒ¼ãƒ³ãŒå®Ÿè£…ã•ã‚Œã¦ã„ã‚‹
- âœ… ãƒ‰ãƒ¡ã‚¤ãƒ³å‹ãŒæ˜ç¢ºã«å®šç¾©ã•ã‚Œã¦ã„ã‚‹
- âš ï¸ ã‚¨ãƒ©ãƒ¼ã‚¯ãƒ©ã‚¹ãŒè¤‡æ•°å®šç¾©ï¼ˆçµ±ä¸€ã®ä½™åœ°ï¼‰

---

### 2.6 design (5ãƒ•ã‚¡ã‚¤ãƒ«) - ãƒ‡ã‚¶ã‚¤ãƒ³ã‚·ã‚¹ãƒ†ãƒ 

```
design/
â”œâ”€â”€ markdown/
â”‚   â”œâ”€â”€ MarkdownRenderer.tsx
â”‚   â”œâ”€â”€ markdownRules.ts
â”‚   â””â”€â”€ markdownStyles.ts
â”‚
â”œâ”€â”€ theme/
â”‚   â””â”€â”€ ThemeContext.tsx  # ãƒ€ãƒ¼ã‚¯ãƒ¢ãƒ¼ãƒ‰/ãƒ©ã‚¤ãƒˆãƒ¢ãƒ¼ãƒ‰
â”‚
â””â”€â”€ styles/
    â””â”€â”€ responsive.ts
```

**è©•ä¾¡**:
- âœ… ãƒ‡ã‚¶ã‚¤ãƒ³ã‚·ã‚¹ãƒ†ãƒ ãŒç‹¬ç«‹ã—ã¦ã„ã‚‹
- âœ… ãƒ†ãƒ¼ãƒç®¡ç†ãŒContext APIã§å®Ÿè£…ï¼ˆé©åˆ‡ï¼‰

---

### 2.7 components (11ãƒ•ã‚¡ã‚¤ãƒ«) - å…±æœ‰UI

```
components/
â”œâ”€â”€ CustomModal.tsx (7,698è¡Œ) âš ï¸ å·¨å¤§åŒ–
â”œâ”€â”€ CustomHeader.tsx
â”œâ”€â”€ CustomInlineInput.tsx
â”œâ”€â”€ FabButton.tsx
â”œâ”€â”€ ListItem.tsx
â”œâ”€â”€ SplashScreen.tsx
â”œâ”€â”€ MainContainer.tsx
â”œâ”€â”€ KeyboardAvoidingWrapper.tsx
â”œâ”€â”€ PurchaseConfirmModal.tsx
â”œâ”€â”€ ActionsListModal.tsx
â””â”€â”€ InputFormModal.tsx
```

**è©•ä¾¡**:
- âš ï¸ **CustomModal.tsx ãŒ7,698è¡Œ** - æœ€å¤§ã®æ‡¸å¿µäº‹é …
- âœ… ä»–ã®ã‚³ãƒ³ãƒãƒ¼ãƒãƒ³ãƒˆã¯é©åˆ‡ãªã‚µã‚¤ã‚º
- âš ï¸ screen/ å†…ã®ãƒ¢ãƒ¼ãƒ€ãƒ«ã¨ã®é–¢ä¿‚æ€§ãŒä¸æ˜ç¢º

---

## 3. çŠ¶æ…‹ç®¡ç†ã®ä½¿ç”¨å®Ÿæ…‹

### 3.1 Zustandã‚¹ãƒˆã‚¢ï¼ˆ3å€‹ï¼‰

#### useChatStore

```typescript
// features/chat/store/chatStore.ts
interface ChatStore {
  messages: ChatMessage[];
  isLoading: boolean;
  attachedFiles: FileFlat[];
  tokenUsageInfo: TokenUsageInfo | null;

  // Actions
  addMessage: (message: ChatMessage) => void;
  clearMessages: () => void;
  setLoading: (loading: boolean) => void;
  // ...
}
```

**è©•ä¾¡**:
- âœ… ç´„79è¡Œã€ã‚·ãƒ³ãƒ—ãƒ«ã§è‰¯å¥½
- âœ… è²¬å‹™ãŒæ˜ç¢ºï¼ˆãƒãƒ£ãƒƒãƒˆé–¢é€£ã®ã¿ï¼‰
- âœ… ã‚·ãƒ³ã‚°ãƒ«ãƒˆãƒ³ãƒ‘ã‚¿ãƒ¼ãƒ³ã‹ã‚‰ã®ç§»è¡ŒæˆåŠŸ

#### useSettingsStore

```typescript
// settings/settingsStore.ts
interface AppSettings {
  // UIè¨­å®š
  theme: 'light' | 'dark' | 'system';
  fontSize: number;
  lineSpacing: number;

  // ç·¨é›†è¨­å®š
  autoSave: boolean;
  defaultEditorMode: 'text' | 'markdown';

  // LLMè¨­å®š
  llmEnabled: boolean;
  privacyMode: boolean;
  aiResponseStyle: string;

  // ãã®ä»–å¤šæ•°...
}
```

**è©•ä¾¡**:
- âš ï¸ ç´„100è¡Œä»¥ä¸Šã€ã‚„ã‚„è¤‡é›‘
- âš ï¸ è²¬å‹™ãŒå¤šã„ï¼ˆUIã€ç·¨é›†ã€LLMã€ã‚»ã‚­ãƒ¥ãƒªãƒ†ã‚£ç­‰ï¼‰
- âœ… AsyncStorageã¸ã®æ°¸ç¶šåŒ–ãŒå®Ÿè£…ã•ã‚Œã¦ã„ã‚‹

#### useFileEditorStore

```typescript
// screen/file-edit/stores/useFileEditorStore.ts
interface FileEditorStore {
  // ãƒ•ã‚¡ã‚¤ãƒ«ç·¨é›†çŠ¶æ…‹
  content: string;
  metadata: FileMetadataFlat | null;

  // UIçŠ¶æ…‹
  isLoading: boolean;
  isSaving: boolean;
  error: string | null;

  // å±¥æ­´
  canUndo: boolean;
  canRedo: boolean;
}
```

**è©•ä¾¡**:
- âœ… ç´„100è¡Œã€é©åˆ‡ãªã‚µã‚¤ã‚º
- âš ï¸ HistoryManagerã¨ã®çµ±åˆãŒå¿…è¦
- âœ… è²¬å‹™ãŒæ˜ç¢º

---

### 3.2 Context API + useReducerï¼ˆ3å€‹ï¼‰

#### FlatListContext

```typescript
// screen/file-list-flat/context/FlatListContext.tsx
// 852è¡Œ âš ï¸

interface FlatListState {
  files: FileFlat[];
  selectedFileIds: Set<string>;
  isSelectionMode: boolean;
  searchQuery: string;
  modals: {
    create: { visible: boolean };
    rename: { visible: boolean; file: FileFlat | null };
    move: { visible: boolean; files: FileFlat[] };
    // ... ä»–ã®ãƒ¢ãƒ¼ãƒ€ãƒ«çŠ¶æ…‹
  };
}

type FlatListAction =
  | { type: 'SET_FILES'; payload: FileFlat[] }
  | { type: 'TOGGLE_SELECT'; payload: string }
  | { type: 'SET_SEARCH_QUERY'; payload: string }
  // ... 8ç¨®é¡ä»¥ä¸Šã®Actionå‹
```

**è©•ä¾¡**:
- âŒ **852è¡Œã¯è¤‡é›‘ã™ãã‚‹**
- âš ï¸ reducer ãŒè¤‡é›‘ã€ãƒ‡ãƒãƒƒã‚°ãŒå›°é›£
- âš ï¸ Zustand ã¸ã®ç§»è¡Œã‚’å¼·ãæ¨å¥¨

#### ChatUIContext

```typescript
// features/chat/ui/contexts/ChatUIContext.tsx
// ç´„66è¡Œ

interface ChatUIContextType {
  // UIçŠ¶æ…‹ï¼ˆã‚¢ãƒ‹ãƒ¡ãƒ¼ã‚·ãƒ§ãƒ³ã€ãƒ•ã‚©ãƒ¼ã‚«ã‚¹ç­‰ï¼‰
  isInputFocused: boolean;
  setInputFocused: (focused: boolean) => void;
  // ...
}
```

**è©•ä¾¡**:
- âœ… è»½é‡ã€é©åˆ‡ãªã‚µã‚¤ã‚º
- âš ï¸ useChatStoreã¨ã®è²¬å‹™é‡è¤‡ã®å¯èƒ½æ€§ã‚’ç¢ºèªå¿…è¦

#### ThemeContext

```typescript
// design/theme/ThemeContext.tsx

interface ThemeContextType {
  theme: 'light' | 'dark' | 'system';
  colors: ColorPalette;
  toggleTheme: () => void;
}
```

**è©•ä¾¡**:
- âœ… è»½é‡ã€å¿…è¦ãªå®Ÿè£…
- âœ… Context APIã®é©åˆ‡ãªä½¿ç”¨ä¾‹

---

### 3.3 çŠ¶æ…‹ç®¡ç†ã®ä½¿ã„åˆ†ã‘ï¼ˆç¾çŠ¶ï¼‰

| æŠ€è¡“ | ä½¿ç”¨ç®‡æ‰€ | é©åˆ‡æ€§ | æ¨å¥¨ |
|-----|---------|--------|------|
| Zustand | useChatStore | âœ… é©åˆ‡ | ç¶™ç¶š |
| Zustand | useSettingsStore | âš ï¸ ã‚„ã‚„è¤‡é›‘ | ç¶™ç¶šï¼ˆåˆ†å‰²æ¤œè¨ï¼‰ |
| Zustand | useFileEditorStore | âœ… é©åˆ‡ | ç¶™ç¶š |
| Context + useReducer | FlatListContext | âŒ è¤‡é›‘ã™ãã‚‹ | **Zustandã¸ç§»è¡Œ** |
| Context API | ChatUIContext | âœ… é©åˆ‡ | ç¶™ç¶š |
| Context API | ThemeContext | âœ… é©åˆ‡ | ç¶™ç¶š |

**æ¨å¥¨ãƒ«ãƒ¼ãƒ«**:
```
1. ã‚°ãƒ­ãƒ¼ãƒãƒ«çŠ¶æ…‹ï¼ˆè¤‡æ•°ç”»é¢ã§å…±æœ‰ï¼‰ â†’ Zustand
2. ãƒ­ãƒ¼ã‚«ãƒ«çŠ¶æ…‹ï¼ˆå˜ä¸€ã‚³ãƒ³ãƒãƒ¼ãƒãƒ³ãƒˆå†…ï¼‰ â†’ useState
3. UI ãƒãƒªã‚¨ãƒ¼ã‚·ãƒ§ãƒ³/ãƒ—ãƒ­ãƒã‚¤ãƒ€ãƒ¼ â†’ Context API
```

---

## 4. ä¾å­˜é–¢ä¿‚ã¨ã‚¢ãƒ¼ã‚­ãƒ†ã‚¯ãƒãƒ£ãƒ‘ã‚¿ãƒ¼ãƒ³

### 4.1 ä¸»è¦ãƒ¢ã‚¸ãƒ¥ãƒ¼ãƒ«é–“ã®ä¾å­˜é–¢ä¿‚ã‚°ãƒ©ãƒ•

```
ChatService (ã‚·ãƒ³ã‚°ãƒ«ãƒˆãƒ³)
â”œâ”€â”€ APIService (LLM Service)
â”‚   â”œâ”€â”€ ConversationHistory
â”‚   â”œâ”€â”€ HttpClient
â”‚   â”œâ”€â”€ RequestManager
â”‚   â”œâ”€â”€ ProviderManager
â”‚   â”œâ”€â”€ SummarizationService
â”‚   â””â”€â”€ WebSocketService (ã‚·ãƒ³ã‚°ãƒ«ãƒˆãƒ³)
â”‚
â”œâ”€â”€ ChatAttachmentService
â”œâ”€â”€ ChatCommandService
â”œâ”€â”€ ChatTokenService
â”œâ”€â”€ ChatWebSocketManager
â””â”€â”€ ChatSummarizationService

ä¾å­˜å…ƒ:
â”œâ”€â”€ useChatStore (Zustand)
â”œâ”€â”€ useSettingsStore (Zustand)
â”œâ”€â”€ FileRepository (@dataå±¤)
â”œâ”€â”€ billing/utils/tokenBalance
â””â”€â”€ logger (@utils)
```

### 4.2 ã‚·ãƒ³ã‚°ãƒ«ãƒˆãƒ³ãƒ‘ã‚¿ãƒ¼ãƒ³ã®ä½¿ç”¨ç®‡æ‰€

| ã‚¯ãƒ©ã‚¹ | å ´æ‰€ | å½±éŸ¿ |
|-------|------|------|
| **ChatService** | `features/chat/index.ts` | âŒ ãƒ†ã‚¹ãƒˆå›°é›£ |
| **WebSocketService** | `features/chat/llmService/services/` | âŒ ãƒ†ã‚¹ãƒˆå›°é›£ |
| **AppInitializer** | `initialization/AppInitializer.ts` | âš ï¸ åˆæœŸåŒ–å°‚ç”¨ãªã®ã§è¨±å®¹å¯èƒ½ |

**å•é¡Œç‚¹**:
```typescript
// ç¾çŠ¶
class ChatService {
  private static instance: ChatService | null = null;

  static getInstance(): ChatService {
    if (!ChatService.instance) {
      ChatService.instance = new ChatService();
    }
    return ChatService.instance;
  }
}

// ãƒ†ã‚¹ãƒˆã§ã®ãƒ¢ãƒƒã‚¯åŒ–ãŒå›°é›£
const service = ChatService.getInstance(); // âŒ ãƒ¢ãƒƒã‚¯ã«å·®ã—æ›¿ãˆã‚‰ã‚Œãªã„
```

---

### 4.3 ç›¸å¯¾ãƒ‘ã‚¹ã®æ·±ã•å•é¡Œ

```
æœ€æ·±ã®ç›¸å¯¾ãƒ‘ã‚¹:
- ../../../../utils/logger (4éšå±¤)

ä½¿ç”¨ç®‡æ‰€:
- app/features/chat/llmService/utils/ErrorHandler.ts
- app/features/chat/llmService/services/WebSocketService.ts

ç¾çŠ¶ã®ãƒ‘ã‚¹ä½¿ç”¨çŠ¶æ³:
- ../../../ : 13å€‹ï¼ˆfeatures/chat ã®ç›´ä¸‹ãƒ¬ã‚¤ãƒ¤ãƒ¼ï¼‰
- ../../../../ : 6å€‹ï¼ˆfeatures/chat/llmService/utils, servicesï¼‰

æ”¹å–„ç­–:
- @features, @shared, @utils ç­‰ã®ãƒ‘ã‚¹ã‚¨ã‚¤ãƒªã‚¢ã‚¹ã‚’è¨­å®š
```

**Before**:
```typescript
import { logger } from '../../../../utils/logger';
import { FileRepository } from '../../../data/repositories/fileRepository';
```

**Afterï¼ˆãƒ‘ã‚¹ã‚¨ã‚¤ãƒªã‚¢ã‚¹è¨­å®šå¾Œï¼‰**:
```typescript
import { logger } from '@shared/utils/logger';
import { FileRepository } from '@features/file/model/repositories';
```

---

### 4.4 å¾ªç’°ä¾å­˜ã®çŠ¶æ³

**ç¾çŠ¶**: âœ… è§£æ±ºæ¸ˆã¿

ãƒªãƒ•ã‚¡ã‚¯ã‚¿ãƒªãƒ³ã‚°å±¥æ­´ã‚ˆã‚Šï¼š
```
commit 8bb4c09 - "refactor: Resolve all circular dependencies in billing and llmService modules"
```

**è©•ä¾¡**:
- âœ… å¾ªç’°ä¾å­˜ã¯æ—¢ã«è§£æ±ºã•ã‚Œã¦ã„ã‚‹
- âœ… ãƒªãƒ•ã‚¡ã‚¯ã‚¿ãƒªãƒ³ã‚°å±¥æ­´ã‹ã‚‰ã€æ„è­˜çš„ã«å¯¾å‡¦ã•ã‚Œã¦ã„ã‚‹
- âš ï¸ ä»Šå¾Œã®é–‹ç™ºã§å†ç™ºé˜²æ­¢ã®ãƒ«ãƒ¼ãƒ«ãŒå¿…è¦

---

## 5. ã‚¨ãƒ©ãƒ¼ãƒãƒ³ãƒ‰ãƒªãƒ³ã‚°ã®ç¾çŠ¶

### 5.1 ã‚¨ãƒ©ãƒ¼ã‚¯ãƒ©ã‚¹ã®å®šç¾©ç®‡æ‰€

#### FileSystemV2Error & RepositoryError

```typescript
// data/core/errors.ts

export class FileSystemV2Error extends Error {
  constructor(
    message: string,
    public code: string,
    public originalError?: unknown
  ) {
    super(message);
    this.name = 'FileSystemV2Error';
  }
}

// ã‚¨ãƒ©ãƒ¼ã‚³ãƒ¼ãƒ‰:
// - CREATE_ERROR
// - READ_ERROR
// - WRITE_ERROR
// - UPDATE_ERROR
// - DELETE_ERROR

export class RepositoryError extends Error {
  constructor(
    message: string,
    public code: string,
    public originalError?: unknown
  ) {
    super(message);
    this.name = 'RepositoryError';
  }
}

// ã‚¨ãƒ©ãƒ¼ã‚³ãƒ¼ãƒ‰:
// - GET_ERROR
// - UPDATE_ERROR
// - MOVE_ERROR
```

#### LLMError

```typescript
// features/chat/llmService/types/LLMError.ts

export class LLMError extends Error {
  constructor(
    message: string,
    public code: string,
    public statusCode?: number,
    public originalError?: unknown
  ) {
    super(message);
    this.name = 'LLMError';
  }
}

// ã‚¨ãƒ©ãƒ¼ã‚³ãƒ¼ãƒ‰:
// - TIMEOUT
// - VALIDATION_ERROR
// - NETWORK_ERROR
```

#### ErrorType enum

```typescript
// features/chat/utils/errorTypes.ts

export enum ErrorType {
  NETWORK = 'NETWORK',
  TIMEOUT = 'TIMEOUT',
  VALIDATION = 'VALIDATION',
  FILE_OPERATION = 'FILE_OPERATION',
  LLM_API = 'LLM_API',
  UNKNOWN = 'UNKNOWN',
}
```

### 5.2 ã‚¨ãƒ©ãƒ¼ãƒãƒ³ãƒ‰ãƒªãƒ³ã‚°ã®å•é¡Œç‚¹

| å•é¡Œ | è©³ç´° | å½±éŸ¿ |
|------|------|------|
| **çµ±ä¸€æ€§ã®æ¬ å¦‚** | 3ç¨®é¡ã®ã‚¨ãƒ©ãƒ¼ã‚¯ãƒ©ã‚¹ + 1ç¨®é¡ã®enum | ãƒ‡ãƒãƒƒã‚°ãŒå›°é›£ |
| **å‘½åè¦å‰‡ã®ä¸ä¸€è‡´** | CREATE_ERROR vs TIMEOUT vs NETWORK | äºˆæ¸¬å›°é›£ |
| **ãƒãƒ³ãƒ‰ãƒªãƒ³ã‚°ã®åˆ†æ•£** | å„æ‰€ã§ç‹¬è‡ªã®try/catch | ä¸€è²«æ€§ãªã— |
| **ã‚°ãƒ­ãƒ¼ãƒãƒ«ãƒã‚¦ãƒ³ãƒ€ãƒªãªã—** | äºˆæœŸã—ãªã„ã‚¨ãƒ©ãƒ¼ãŒã‚­ãƒ£ãƒƒãƒã•ã‚Œãªã„ | UXä½ä¸‹ |

### 5.3 ã‚¨ãƒ©ãƒ¼ãƒãƒ³ãƒ‰ãƒªãƒ³ã‚°ãƒ•ãƒ­ãƒ¼ï¼ˆç¾çŠ¶ï¼‰

```
ã‚¨ãƒ©ãƒ¼ç™ºç”Ÿ
    â†“
try/catch ï¼ˆå„æ‰€ã§å€‹åˆ¥å®Ÿè£…ï¼‰
    â†“
    â”œâ”€â”€ UnifiedErrorHandler (features/chat/utils/errorHandler.ts)
    â”‚   â””â”€â”€ handleChatError() ã§çµ±ä¸€ï¼ˆãƒãƒ£ãƒƒãƒˆé–¢é€£ã®ã¿ï¼‰
    â”‚
    â”œâ”€â”€ ErrorService (screen/file-edit/services/ErrorService.ts)
    â”‚   â””â”€â”€ ç”»é¢å›ºæœ‰ã®ã‚¨ãƒ©ãƒ¼å‡¦ç†
    â”‚
    â””â”€â”€ å€‹åˆ¥ã®catchå¥ï¼ˆçµ±ä¸€ã•ã‚Œã¦ã„ãªã„ï¼‰

èª²é¡Œ:
- ã‚¨ãƒ©ãƒ¼ãƒãƒ³ãƒ‰ãƒªãƒ³ã‚°ãŒçµ±ä¸€ã•ã‚Œã¦ã„ãªã„
- ã‚°ãƒ­ãƒ¼ãƒãƒ«ã‚¨ãƒ©ãƒ¼ãƒã‚¦ãƒ³ãƒ€ãƒªãŒãªã„
- ã‚¨ãƒ©ãƒ¼ãƒªã‚«ãƒãƒªãƒ¼ã‚¹ãƒˆãƒ©ãƒ†ã‚¸ãƒ¼ãŒä¸æ˜ç¢º
```

---

## 6. ãƒ‘ãƒ•ã‚©ãƒ¼ãƒãƒ³ã‚¹ãƒœãƒˆãƒ«ãƒãƒƒã‚¯

### 6.1 FileRepository.getAll() ã®ãƒ¡ãƒ¢ãƒªå•é¡Œ

#### ç¾åœ¨ã®å®Ÿè£…

```typescript
// data/repositories/fileRepository.ts

static async getAll(): Promise<FileFlat[]> {
  const items = await CONTENT_DIR.list();  // ãƒ‡ã‚£ãƒ¬ã‚¯ãƒˆãƒªãƒªã‚¹ãƒˆå–å¾—

  const filePromises = items
    .filter(item => item instanceof Directory)
    .map(async (item) => {
      const fileDir = item as Directory;

      // å„ãƒ•ã‚¡ã‚¤ãƒ«ã®å‡¦ç†
      const metadata = await readFileMetadata(fileDir);  // JSONèª­ã¿è¾¼ã¿
      const content = await readFileContent(fileDir);    // ãƒ•ã‚¡ã‚¤ãƒ«å†…å®¹å…¨ä½“ âš ï¸

      return metadataToFile(metadata, content);
    });

  // å…¨ãƒ•ã‚¡ã‚¤ãƒ«ã‚’ä¸¦åˆ—èª­ã¿è¾¼ã¿ âš ï¸
  const results = await Promise.all(filePromises);

  return results;
}
```

#### å•é¡Œç‚¹

| å•é¡Œ | è©³ç´° | å½±éŸ¿ |
|------|------|------|
| **å…¨ãƒ•ã‚¡ã‚¤ãƒ«èª­ã¿è¾¼ã¿** | ãƒ¡ã‚¿ãƒ‡ãƒ¼ã‚¿ã ã‘ã§ãªãå†…å®¹ã‚‚å…¨ã¦èª­ã¿è¾¼ã‚€ | ãƒ¡ãƒ¢ãƒªä½¿ç”¨é‡å¤§ |
| **ä¸¦åˆ—åº¦ç„¡åˆ¶é™** | Promise.all()ã§å…¨ã¦ä¸¦åˆ—å®Ÿè¡Œ | å¤§é‡ãƒ•ã‚¡ã‚¤ãƒ«æ™‚ã«ãƒªã‚½ãƒ¼ã‚¹ä¸è¶³ |
| **ãƒšãƒ¼ã‚¸ãƒãƒ¼ã‚·ãƒ§ãƒ³ãªã—** | å…¨ãƒ•ã‚¡ã‚¤ãƒ«ã‚’ä¸€åº¦ã«å–å¾— | 1000ä»¶è¶…ã§ãƒ¡ãƒ¢ãƒªä¸è¶³ã®å¯èƒ½æ€§ |

#### æ¨å®šãƒ¡ãƒ¢ãƒªä½¿ç”¨é‡

```
æƒ³å®š:
- ãƒ•ã‚¡ã‚¤ãƒ«æ•°: 1000ä»¶
- å¹³å‡ãƒ•ã‚¡ã‚¤ãƒ«ã‚µã‚¤ã‚º: 10KB
- ãƒ¡ã‚¿ãƒ‡ãƒ¼ã‚¿: 1KB/ãƒ•ã‚¡ã‚¤ãƒ«

è¨ˆç®—:
(10KB + 1KB) Ã— 1000 = 11MB (æœ€å°)

å®Ÿéš›ã¯:
- ã‚ªãƒ–ã‚¸ã‚§ã‚¯ãƒˆç”Ÿæˆã®ã‚ªãƒ¼ãƒãƒ¼ãƒ˜ãƒƒãƒ‰
- æ–‡å­—åˆ—ã®å†…éƒ¨è¡¨ç¾
- é…åˆ—ã®ãƒ¡ãƒ¢ãƒª
â†’ ç´„30-50MB ã®ãƒ¡ãƒ¢ãƒªä½¿ç”¨ãŒäºˆæƒ³ã•ã‚Œã‚‹
```

---

### 6.2 ä¼šè©±å±¥æ­´ã®ãƒ¡ãƒ¢ãƒªç®¡ç†

#### ConversationHistory ã®å®Ÿè£…

```typescript
// features/chat/llmService/core/ConversationHistory.ts

class ConversationHistory {
  private maxHistorySize: number = 100;  // å›ºå®šå€¤
  private messages: ChatMessage[] = [];

  addMessage(message: ChatMessage) {
    this.messages.push(message);

    // ä¸Šé™ã‚’è¶…ãˆãŸã‚‰å¤ã„ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸ã‚’å‰Šé™¤
    if (this.messages.length > this.maxHistorySize) {
      this.messages.shift();
    }
  }
}
```

#### å•é¡Œç‚¹

```
å„ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸ã®æ§‹é€ :
{
  id: string,
  content: string,           // ãƒ†ã‚­ã‚¹ãƒˆå†…å®¹
  timestamp: Date,
  attachedFiles: FileFlat[], // ãƒ•ã‚¡ã‚¤ãƒ«ã®å®Œå…¨ãªå†…å®¹ã‚’å«ã‚€ âš ï¸
  tokensUsed: number,
  // ...
}

èª²é¡Œ:
1. attachedFiles ã«ãƒ•ã‚¡ã‚¤ãƒ«ã®å…¨å†…å®¹ãŒå«ã¾ã‚Œã‚‹
2. å¤§å®¹é‡ãƒ•ã‚¡ã‚¤ãƒ« Ã— å¤šæ•°ã®æ·»ä»˜ã§ãƒ¡ãƒ¢ãƒªæ€¥å¢—
3. maxHistorySize = 100 ã¯å›ºå®šå€¤ï¼ˆè¨­å®šä¸å¯ï¼‰
```

**ä¾‹**:
```
10å€‹ã®ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸ Ã— 5å€‹ã®æ·»ä»˜ãƒ•ã‚¡ã‚¤ãƒ« Ã— å¹³å‡10KB
= 500KB ï¼ˆé©åº¦ï¼‰

100å€‹ã®ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸ Ã— 5å€‹ã®æ·»ä»˜ãƒ•ã‚¡ã‚¤ãƒ« Ã— å¹³å‡10KB
= 5MB ï¼ˆè¨±å®¹ç¯„å›²ï¼‰

100å€‹ã®ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸ Ã— 10å€‹ã®æ·»ä»˜ãƒ•ã‚¡ã‚¤ãƒ« Ã— å¹³å‡100KB
= 100MB ï¼ˆå•é¡Œã‚ã‚Šï¼‰
```

---

### 6.3 ä»®æƒ³åŒ–ã®æ¬ å¦‚

#### ChatHistoryï¼ˆãƒ¡ãƒƒã‚»ãƒ¼ã‚¸ãƒªã‚¹ãƒˆï¼‰

```typescript
// features/chat/components/ChatHistory.tsx

// ä»®æƒ³åŒ–ãªã—
<ScrollView>
  {messages.map((message) => (
    <MessageItem key={message.id} message={message} />
  ))}
</ScrollView>
```

**å•é¡Œ**:
- å…¨ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸ã‚’DOMã«ãƒ¬ãƒ³ãƒ€ãƒªãƒ³ã‚°
- ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸æ•°ãŒå¢—ãˆã‚‹ã¨ãƒ‘ãƒ•ã‚©ãƒ¼ãƒãƒ³ã‚¹ä½ä¸‹

#### FileListï¼ˆãƒ•ã‚¡ã‚¤ãƒ«ä¸€è¦§ï¼‰

```typescript
// screen/file-list-flat/components/...

// FlatListä½¿ç”¨ï¼ˆReact Nativeã®ä»®æƒ³åŒ–ãƒªã‚¹ãƒˆï¼‰
<FlatList
  data={files}
  renderItem={({ item }) => <FileListItem file={item} />}
/>
```

**è©•ä¾¡**:
- âœ… FlatListã§ä»®æƒ³åŒ–ã•ã‚Œã¦ã„ã‚‹ï¼ˆè‰¯å¥½ï¼‰

---

### 6.4 åˆæœŸåŒ–ã‚¿ã‚¹ã‚¯ã®ä¸¦åˆ—åŒ–å¯èƒ½æ€§

#### ç¾åœ¨ã®ãƒ•ãƒ­ãƒ¼ï¼ˆé †åºå®Ÿè¡Œï¼‰

```typescript
// initialization/AppInitializer.ts

// Stage 1: CRITICALï¼ˆé †åºå®Ÿè¡Œï¼‰
await this.executeTask('authenticateDevice');
await this.executeTask('initializeFileSystem');
await this.executeTask('verifyAsyncStorage');
await this.executeTask('loadSettings');

// Stage 2: CORE
await this.executeTask('loadIconFonts');
await this.executeTask('configureLLMService');

// Stage 3: SERVICES
await this.executeTask('initializeWebSocket');
await this.executeTask('configureChatService');
await this.executeTask('initializeBillingService');
await this.executeTask('preloadLLMProviders');  // â† configureLLMService ã®å¾Œ
await this.executeTask('loadToolDefinitions');
await this.executeTask('restorePendingPurchases'); // â† initializeBillingService ã®å¾Œ
```

#### ä¸¦åˆ—å®Ÿè¡Œå¯èƒ½ãªã‚¿ã‚¹ã‚¯

**Stage 1ï¼ˆå®Œå…¨ä¸¦åˆ—å¯èƒ½ï¼‰**:
```typescript
await Promise.all([
  this.executeTask('authenticateDevice'),
  this.executeTask('initializeFileSystem'),
  this.executeTask('verifyAsyncStorage'),
  this.executeTask('loadSettings'),
]);
```

**Stage 3ï¼ˆéƒ¨åˆ†çš„ã«ä¸¦åˆ—å¯èƒ½ï¼‰**:
```typescript
// ã‚°ãƒ«ãƒ¼ãƒ—1ï¼ˆä¸¦åˆ—ï¼‰
await Promise.all([
  this.executeTask('initializeWebSocket'),
  this.executeTask('configureChatService'),
  this.executeTask('initializeBillingService'),
  this.executeTask('configureLLMService'),
  this.executeTask('loadToolDefinitions'),
]);

// ã‚°ãƒ«ãƒ¼ãƒ—2ï¼ˆä¸¦åˆ—ã€ã‚°ãƒ«ãƒ¼ãƒ—1ã®å¾Œï¼‰
await Promise.all([
  this.executeTask('preloadLLMProviders'),
  this.executeTask('restorePendingPurchases'),
]);
```

**æœŸå¾…åŠ¹æœ**:
- èµ·å‹•æ™‚é–“ãŒç´„30-40%çŸ­ç¸®ã•ã‚Œã‚‹å¯èƒ½æ€§

---

## 7. èª²é¡Œã®å„ªå…ˆé †ä½ä»˜ãåˆ†æ

### 7.1 CRITICALï¼ˆå³åº§ã«å¯¾å‡¦ã™ã¹ãï¼‰

#### èª²é¡Œ1: ã‚·ãƒ³ã‚°ãƒ«ãƒˆãƒ³ãƒ‘ã‚¿ãƒ¼ãƒ³ã«ã‚ˆã‚‹ãƒ†ã‚¹ãƒˆå›°é›£æ€§

**å½±éŸ¿ç¯„å›²**: ãƒ†ã‚¹ãƒˆå…¨èˆ¬ã€ã‚³ãƒ¼ãƒ‰å“è³ª

**è©³ç´°**:
```typescript
// features/chat/index.ts
export default ChatService.getInstance();

// å•é¡Œ:
// 1. getInstance()ã¯ãƒ¢ãƒƒã‚¯åŒ–ã§ããªã„
// 2. ãƒ†ã‚¹ãƒˆã”ã¨ã«çŠ¶æ…‹ãŒãƒªã‚»ãƒƒãƒˆã•ã‚Œãªã„
// 3. ä¾å­˜é–¢ä¿‚ãŒéš è”½ã•ã‚Œã‚‹
```

**è§£æ±ºç­–**: DI (Dependency Injection) ãƒ‘ã‚¿ãƒ¼ãƒ³å°å…¥

```typescript
// æ”¹å–„æ¡ˆ
export interface ChatServiceDependencies {
  attachmentService: ChatAttachmentService;
  commandService: ChatCommandService;
  tokenService: ChatTokenService;
  wsManager: ChatWebSocketManager;
}

export class ChatService {
  constructor(private deps: ChatServiceDependencies) {}

  static create(deps?: Partial<ChatServiceDependencies>): ChatService {
    const defaultDeps = {
      attachmentService: new ChatAttachmentService(),
      commandService: new ChatCommandService(),
      tokenService: new ChatTokenService(),
      wsManager: new ChatWebSocketManager(),
    };
    return new ChatService({ ...defaultDeps, ...deps });
  }
}

// ãƒ†ã‚¹ãƒˆä½¿ç”¨
const mockService = ChatService.create({
  attachmentService: mockAttachmentService,
});
```

---

#### èª²é¡Œ2: ã‚¨ãƒ©ãƒ¼ãƒãƒ³ãƒ‰ãƒªãƒ³ã‚°ã®çµ±ä¸€æ€§æ¬ å¦‚

**å½±éŸ¿ç¯„å›²**: ãƒ‡ãƒãƒƒã‚°æ€§ã€UXã€ä¿å®ˆæ€§

**è©³ç´°**:
- 3ç¨®é¡ã®ã‚¨ãƒ©ãƒ¼ã‚¯ãƒ©ã‚¹ï¼ˆFileSystemV2Error, RepositoryError, LLMErrorï¼‰
- 1ç¨®é¡ã®enumï¼ˆErrorTypeï¼‰
- å‘½åè¦å‰‡ã®ä¸ä¸€è‡´
- ã‚°ãƒ­ãƒ¼ãƒãƒ«ã‚¨ãƒ©ãƒ¼ãƒã‚¦ãƒ³ãƒ€ãƒªãªã—

**è§£æ±ºç­–**: çµ±ä¸€ã•ã‚ŒãŸAppErrorãƒ™ãƒ¼ã‚¹ã‚¯ãƒ©ã‚¹

```typescript
// core/errors/AppError.ts
export class AppError extends Error {
  constructor(
    public readonly code: string,
    message: string,
    public readonly domain: 'file' | 'chat' | 'llm' | 'system' | 'billing',
    public readonly originalError?: unknown,
    public readonly metadata?: Record<string, any>
  ) {
    super(message);
    this.name = 'AppError';
  }
}

// core/errors/FileError.ts
export class FileError extends AppError {
  constructor(code: string, message: string, originalError?: unknown) {
    super(code, message, 'file', originalError);
  }
}

// ä½¿ç”¨ä¾‹
throw new FileError('FILE_CREATE_FAILED', 'ãƒ•ã‚¡ã‚¤ãƒ«ä½œæˆã«å¤±æ•—ã—ã¾ã—ãŸ', error);
```

---

#### èª²é¡Œ3: çŠ¶æ…‹ç®¡ç†ã®æ··åœ¨ã¨ä½¿ã„åˆ†ã‘ãƒ«ãƒ¼ãƒ«ä¸æ˜ç¢º

**å½±éŸ¿ç¯„å›²**: ã‚³ãƒ¼ãƒ‰å¯èª­æ€§ã€ãƒ‡ãƒãƒƒã‚°æ€§ã€å­¦ç¿’ã‚³ã‚¹ãƒˆ

**è©³ç´°**:
- Zustand: 3ç®‡æ‰€
- Context API + useReducer: FlatListContextï¼ˆ852è¡Œï¼‰
- ä½¿ã„åˆ†ã‘ã®æ˜ç¢ºãªãƒ«ãƒ¼ãƒ«ãŒãªã„

**è§£æ±ºç­–**: ä½¿ã„åˆ†ã‘ãƒ«ãƒ¼ãƒ«ã®æ˜ç¢ºåŒ–ã¨FlatListContextã®ç§»è¡Œ

```
æ¨å¥¨ãƒ«ãƒ¼ãƒ«:
1. ã‚°ãƒ­ãƒ¼ãƒãƒ«çŠ¶æ…‹ï¼ˆè¤‡æ•°ç”»é¢ã§å…±æœ‰ï¼‰ â†’ Zustand
2. ãƒ­ãƒ¼ã‚«ãƒ«çŠ¶æ…‹ï¼ˆå˜ä¸€ã‚³ãƒ³ãƒãƒ¼ãƒãƒ³ãƒˆå†…ï¼‰ â†’ useState
3. UI ãƒãƒªã‚¨ãƒ¼ã‚·ãƒ§ãƒ³/ãƒ—ãƒ­ãƒã‚¤ãƒ€ãƒ¼ â†’ Context API
```

**FlatListContext â†’ useFileListStore ç§»è¡Œ**:
```typescript
// Before: 852è¡Œã®Context + useReducer
const [state, dispatch] = useReducer(flatListReducer, initialState);

// After: Zustandã‚¹ãƒˆã‚¢ï¼ˆç´„150è¡Œã«å‰Šæ¸›ï¼‰
export const useFileListStore = create<FileListStore>((set, get) => ({
  files: [],
  selectedFileIds: new Set(),
  isSelectionMode: false,
  searchQuery: '',

  setFiles: (files) => set({ files }),
  toggleSelectFile: (fileId) => set((state) => {
    const newSet = new Set(state.selectedFileIds);
    newSet.has(fileId) ? newSet.delete(fileId) : newSet.add(fileId);
    return { selectedFileIds: newSet };
  }),

  async refreshData() {
    const files = await FileRepository.getAll();
    set({ files });
  },
}));
```

---

### 7.2 HIGHï¼ˆæ—©æœŸã«å¯¾å‡¦ã™ã¹ãï¼‰

#### èª²é¡Œ4: CustomModalã®å·¨å¤§åŒ–ï¼ˆ7,698è¡Œï¼‰

**å½±éŸ¿ç¯„å›²**: ä¿å®ˆæ€§ã€å¤‰æ›´ãƒªã‚¹ã‚¯

**è©³ç´°**:
- å˜ä¸€ãƒ•ã‚¡ã‚¤ãƒ«ãŒ7,698è¡Œ
- è¤‡æ•°ç¨®é¡ã®ãƒ¢ãƒ¼ãƒ€ãƒ«ãŒæ··åœ¨ã—ã¦ã„ã‚‹å¯èƒ½æ€§
- å¤‰æ›´æ™‚ã®å½±éŸ¿ç¯„å›²ãŒå¤§ãã„

**è§£æ±ºç­–**: Compound Componentãƒ‘ã‚¿ãƒ¼ãƒ³ã§åˆ†å‰²

```typescript
// Before: CustomModal.tsx (7,698è¡Œ)

// After: åˆ†å‰²å¾Œ
// shared/components/Modal/Modal.tsx (åŸºåº•ã‚³ãƒ³ãƒãƒ¼ãƒãƒ³ãƒˆ)
// shared/components/Modal/ModalHeader.tsx
// shared/components/Modal/ModalBody.tsx
// shared/components/Modal/ModalFooter.tsx
// shared/components/Modal/variants/ConfirmModal.tsx
// shared/components/Modal/variants/FormModal.tsx
// shared/components/Modal/variants/ActionsModal.tsx

// å„ãƒ¢ãƒ¼ãƒ€ãƒ«ã¯200-300è¡Œç¨‹åº¦ã«åã‚ã‚‹
```

---

#### èª²é¡Œ5: FileRepository.getAll() ã®ãƒ‘ãƒ•ã‚©ãƒ¼ãƒãƒ³ã‚¹å•é¡Œ

**å½±éŸ¿ç¯„å›²**: ãƒ¡ãƒ¢ãƒªä½¿ç”¨é‡ã€ãƒ‘ãƒ•ã‚©ãƒ¼ãƒãƒ³ã‚¹

**è§£æ±ºç­–**: ãƒšãƒ¼ã‚¸ãƒãƒ¼ã‚·ãƒ§ãƒ³ã¨ä¸¦åˆ—åº¦åˆ¶å¾¡

```typescript
interface GetAllOptions {
  includeContent?: boolean;  // default: true
  pageSize?: number;         // default: 50
  pageNumber?: number;       // default: 1
  maxConcurrent?: number;    // default: 3
}

static async getAll(options: GetAllOptions = {}): Promise<FileFlat[]> {
  const { includeContent = true, pageSize = 50, pageNumber = 1, maxConcurrent = 3 } = options;

  const items = await CONTENT_DIR.list();

  // ãƒšãƒ¼ã‚¸ãƒ³ã‚°
  const start = (pageNumber - 1) * pageSize;
  const pagedItems = items.slice(start, start + pageSize);

  // ä¸¦åˆ—åº¦åˆ¶å¾¡
  const results = [];
  for (let i = 0; i < pagedItems.length; i += maxConcurrent) {
    const batch = pagedItems.slice(i, i + maxConcurrent);
    const batchResults = await Promise.all(
      batch.map(async (item) => {
        const metadata = await readFileMetadata(fileDir);
        const content = includeContent ? await readFileContent(fileDir) : '';
        return metadataToFile(metadata, content);
      })
    );
    results.push(...batchResults);
  }

  return results;
}

// ä½¿ç”¨ä¾‹ï¼ˆãƒ¡ã‚¿ãƒ‡ãƒ¼ã‚¿ã®ã¿å–å¾—ï¼‰
const files = await FileRepository.getAll({ includeContent: false });
```

---

#### èª²é¡Œ6: åˆæœŸåŒ–ã‚¿ã‚¹ã‚¯ã®æœ€é©åŒ–

**å½±éŸ¿ç¯„å›²**: èµ·å‹•æ™‚é–“

**è§£æ±ºç­–**: ä¸¦åˆ—å®Ÿè¡Œã‚°ãƒ«ãƒ¼ãƒ—åŒ–

```typescript
// Stage 1: å®Œå…¨ä¸¦åˆ—
await Promise.all([
  this.executeTask('verifyAsyncStorage'),
  this.executeTask('initializeFileSystem'),
  this.executeTask('loadSettings'),
  this.executeTask('authenticateDevice'),
]);

// Stage 2: ä¸€éƒ¨ä¸¦åˆ—
await Promise.all([
  this.executeTask('configureLLMService'),
  this.executeTask('initializeWebSocket'),
  this.executeTask('initializeBillingService'),
  this.executeTask('loadToolDefinitions'),
]);

// Stage 3: ä¾å­˜é–¢ä¿‚ã‚ã‚Šï¼ˆé †åºå®Ÿè¡Œï¼‰
await this.executeTask('preloadLLMProviders');
await this.executeTask('restorePendingPurchases');
```

---

### 7.3 MEDIUMï¼ˆè¨ˆç”»çš„ã«å¯¾å‡¦ï¼‰

#### èª²é¡Œ7: ãƒ‡ã‚£ãƒ¬ã‚¯ãƒˆãƒªæ§‹é€ ã®å†æ•´å‚™

**å½±éŸ¿ç¯„å›²**: é•·æœŸçš„ãªä¿å®ˆæ€§

**è©³ç´°**:
- `screen` vs `features` ã®åŒºåˆ¥ãŒæ›–æ˜§
- `components` ãŒè¤‡æ•°ç®‡æ‰€ã«åˆ†æ•£
- `services` ãŒè¤‡æ•°å±¤ã«å­˜åœ¨

**è§£æ±ºç­–**: FSD (Feature-Sliced Design) ã®å®Œå…¨å®Ÿè£…

```
app/
â”œâ”€â”€ core/          # çµ±ä¸€ã‚¨ãƒ©ãƒ¼ã€ã‚°ãƒ­ãƒ¼ãƒãƒ«å‹
â”œâ”€â”€ shared/        # å…±æœ‰ã‚³ãƒ³ãƒãƒ¼ãƒãƒ³ãƒˆ/hooks/utils
â”œâ”€â”€ features/      # æ©Ÿèƒ½ãƒ¢ã‚¸ãƒ¥ãƒ¼ãƒ«ï¼ˆchat, fileï¼‰
â”œâ”€â”€ screens/       # ãƒ«ãƒ¼ãƒ†ã‚£ãƒ³ã‚°å¯¾å¿œç”»é¢ã®ã¿
â””â”€â”€ data/design/billing/... # ç¾çŠ¶ç¶­æŒ
```

---

#### èª²é¡Œ8: ãƒ†ã‚¹ãƒˆæˆ¦ç•¥ã®æ§‹ç¯‰

**å½±éŸ¿ç¯„å›²**: ã‚³ãƒ¼ãƒ‰å“è³ªã€ãƒªã‚°ãƒ¬ãƒƒã‚·ãƒ§ãƒ³é˜²æ­¢

**ç¾çŠ¶**: ãƒ†ã‚¹ãƒˆãƒ•ã‚¡ã‚¤ãƒ«ãŒã»ã¼ãªã„

**è§£æ±ºç­–**:
1. Phase 1ï¼ˆDIå°å…¥ï¼‰å¾Œã€å˜ä½“ãƒ†ã‚¹ãƒˆã‚’è¿½åŠ 
2. Jest + React Testing Library ã‚’ä½¿ç”¨
3. ãƒ†ã‚¹ãƒˆã‚«ãƒãƒ¬ãƒƒã‚¸ç›®æ¨™: 60%ä»¥ä¸Š

---

### 7.4 LOWï¼ˆå°†æ¥çš„ã«æ¤œè¨ï¼‰

#### èª²é¡Œ9: ãƒ¢ãƒ€ãƒ³ã‚¢ãƒ¼ã‚­ãƒ†ã‚¯ãƒãƒ£ãƒ‘ã‚¿ãƒ¼ãƒ³ã®å®Œå…¨æ¡ç”¨

**å€™è£œ**:
- FSD (Feature-Sliced Design): **æ¨å¥¨** â† æ—¢ã«ä¸€éƒ¨å®Ÿè£…æ¸ˆã¿
- Clean Architecture: è¤‡é›‘ã™ãã‚‹å¯èƒ½æ€§
- Atomic Design: UIã‚³ãƒ³ãƒãƒ¼ãƒãƒ³ãƒˆåˆ†é¡ã«æœ‰åŠ¹

---

## 8. æ—¢å­˜ã®ãƒ™ã‚¹ãƒˆãƒ—ãƒ©ã‚¯ãƒ†ã‚£ã‚¹

### 8.1 FSDï¼ˆFeature-Sliced Designï¼‰ã®éƒ¨åˆ†å°å…¥

**å ´æ‰€**: `features/chat/`

**è©•ä¾¡**: âœ… å„ªã‚ŒãŸå®Ÿè£…

```
features/chat/
â”œâ”€â”€ ui/           # UIãƒ¬ã‚¤ãƒ¤ãƒ¼
â”œâ”€â”€ model/        # ãƒ“ã‚¸ãƒã‚¹ãƒ­ã‚¸ãƒƒã‚¯ï¼ˆæš—é»™çš„ï¼‰
â”œâ”€â”€ api/          # APIé€šä¿¡å±¤ï¼ˆæš—é»™çš„ï¼‰
â””â”€â”€ store/        # çŠ¶æ…‹ç®¡ç†
```

**è‰¯ã„ç‚¹**:
- å±¤ã®åˆ†é›¢ãŒæ˜ç¢º
- æ©Ÿèƒ½å˜ä½ã§ã®ç‹¬ç«‹æ€§ãŒé«˜ã„
- æ‹¡å¼µãŒå®¹æ˜“

---

### 8.2 è²¬å‹™ã®éƒ¨åˆ†çš„åˆ†é›¢

**å ´æ‰€**: `features/chat/services/`

**è©•ä¾¡**: âœ… è‰¯å¥½

```
ChatAttachmentService  # ãƒ•ã‚¡ã‚¤ãƒ«æ·»ä»˜
ChatCommandService     # ã‚³ãƒãƒ³ãƒ‰å®Ÿè¡Œ
ChatTokenService       # ãƒˆãƒ¼ã‚¯ãƒ³ç®¡ç†
ChatWebSocketManager   # WebSocketç®¡ç†
ChatSummarizationService # è¦ç´„
```

**è‰¯ã„ç‚¹**:
- å„ã‚µãƒ¼ãƒ“ã‚¹ãŒç‹¬ç«‹ã—ã¦ã„ã‚‹
- è²¬å‹™ãŒæ˜ç¢º
- å†åˆ©ç”¨å¯èƒ½

---

### 8.3 Zustandã«ã‚ˆã‚‹ãƒ¢ãƒ€ãƒ³ãªçŠ¶æ…‹ç®¡ç†

**å ´æ‰€**: `useChatStore`, `useFileEditorStore`, `useSettingsStore`

**è©•ä¾¡**: âœ… é©åˆ‡ãªæŠ€è¡“é¸æŠ

**è‰¯ã„ç‚¹**:
- Reduxæ¯”ã§å­¦ç¿’ã‚³ã‚¹ãƒˆãŒä½ã„
- ãƒœã‚¤ãƒ©ãƒ¼ãƒ—ãƒ¬ãƒ¼ãƒˆãŒå°‘ãªã„
- TypeScriptã¨ã®ç›¸æ€§ãŒè‰¯ã„

---

### 8.4 å¾ªç’°ä¾å­˜ã®è§£æ±º

**è©•ä¾¡**: âœ… æ„è­˜çš„ã«å¯¾å‡¦ã•ã‚Œã¦ã„ã‚‹

**è¨¼æ‹ **:
```
commit 8bb4c09 - "refactor: Resolve all circular dependencies in billing and llmService modules"
```

---

## 9. æ¨å¥¨ã‚¢ãƒ¼ã‚­ãƒ†ã‚¯ãƒãƒ£è©³ç´°

### 9.1 FSD (Feature-Sliced Design) ã®å®Œå…¨æ¡ç”¨

#### ç†ç”±

1. **æ—¢ã«ä¸€éƒ¨å°å…¥æ¸ˆã¿** - `features/chat` ã§åŸºç¤ãŒç¢ºç«‹
2. **æ©Ÿèƒ½å˜ä½ã§ã®ç‹¬ç«‹æ€§** - ãƒãƒ¼ãƒ é–‹ç™ºã«æœ€é©
3. **ã‚¹ã‚±ãƒ¼ãƒ©ãƒ–ãƒ«** - æ–°æ©Ÿèƒ½è¿½åŠ ãŒå®¹æ˜“
4. **React Nativeã¨ã®ç›¸æ€§** - å®Ÿç¸¾ã‚ã‚Š

#### å±¤æ§‹é€ 

```
ã‚¢ãƒ¼ã‚­ãƒ†ã‚¯ãƒãƒ£æ§‹é€ :
â”Œâ”€ Shared (å†åˆ©ç”¨å¯èƒ½)
â”‚  â”œâ”€â”€ UI (CustomModal, InputFormç­‰)
â”‚  â”œâ”€â”€ Hooks (useTheme, useAsyncç­‰)
â”‚  â”œâ”€â”€ Utils (logger, formattersç­‰)
â”‚  â””â”€â”€ Types (å…±æœ‰å‹å®šç¾©)
â”‚
â”œâ”€ Entities (ãƒ‰ãƒ¡ã‚¤ãƒ³ãƒ¢ãƒ‡ãƒ«)
â”‚  â””â”€â”€ File (FileFlat typeå®šç¾©ã€æ¤œè¨¼ãƒ­ã‚¸ãƒƒã‚¯)
â”‚
â”œâ”€ Features (æ©Ÿèƒ½å˜ä½ã€å®Œå…¨ã«ç‹¬ç«‹)
â”‚  â”œâ”€â”€ chat/
â”‚  â”‚  â”œâ”€â”€ ui/           # UIå±¤
â”‚  â”‚  â”œâ”€â”€ model/        # ãƒ“ã‚¸ãƒã‚¹ãƒ­ã‚¸ãƒƒã‚¯
â”‚  â”‚  â”œâ”€â”€ api/          # APIå±¤
â”‚  â”‚  â””â”€â”€ store/        # çŠ¶æ…‹ç®¡ç†
â”‚  â””â”€â”€ file/
â”‚
â”œâ”€ Pages (ãƒ«ãƒ¼ãƒ†ã‚£ãƒ³ã‚°/ç”»é¢)
â”‚  â”œâ”€â”€ FileListScreen
â”‚  â”œâ”€â”€ FileEditScreen
â”‚  â””â”€â”€ ChatScreen
â”‚
â””â”€ App (ã‚¢ãƒ—ãƒªã‚±ãƒ¼ã‚·ãƒ§ãƒ³å±¤)
   â”œâ”€â”€ initialization/
   â””â”€â”€ navigation/
```

---

### 9.2 ä¾å­˜é–¢ä¿‚ã®æ–¹å‘æ€§

```
       shared/
         â†‘
    â”Œâ”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”
    â”‚             â”‚
features/*    screens/*
    â”‚             â”‚
    â””â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”˜
         â†“
      data/
      design/

è¨±å¯ã•ã‚Œã‚‹ä¾å­˜:
âœ… screens/ â†’ features/     (æ©Ÿèƒ½ã‚’ä½¿ç”¨)
âœ… screens/ â†’ shared/       (å…±æœ‰ã‚³ãƒ³ãƒãƒ¼ãƒãƒ³ãƒˆã‚’ä½¿ç”¨)
âœ… features/* â†’ shared/     (å…±æœ‰ãƒªã‚½ãƒ¼ã‚¹ã‚’ä½¿ç”¨)
âœ… features/* â†’ data/       (ãƒ‡ãƒ¼ã‚¿ãƒ¬ã‚¤ãƒ¤ãƒ¼ã‚’ä½¿ç”¨)

ç¦æ­¢ã•ã‚Œã‚‹ä¾å­˜:
âŒ features/chat â†’ features/file (ã‚¯ãƒ­ã‚¹æ©Ÿèƒ½)
âŒ shared/ â†’ features/*          (ä¸‹å±¤ã¸ã®ä¾å­˜)
âŒ data/ â†’ features/*            (ä¸Šå±¤ã¸ã®ä¾å­˜)
```

---

### 9.3 æŠ€è¡“ã‚¹ã‚¿ãƒƒã‚¯

| é ˜åŸŸ | æŠ€è¡“ | ç†ç”± |
|------|------|------|
| **çŠ¶æ…‹ç®¡ç†ï¼ˆã‚°ãƒ­ãƒ¼ãƒãƒ«ï¼‰** | Zustand | ãƒœã‚¤ãƒ©ãƒ¼ãƒ—ãƒ¬ãƒ¼ãƒˆå°‘ã€æ—¢ã«å°å…¥æ¸ˆã¿ |
| **çŠ¶æ…‹ç®¡ç†ï¼ˆUIï¼‰** | Context API | ãƒ—ãƒ­ãƒã‚¤ãƒ€ãƒ¼ãƒ‘ã‚¿ãƒ¼ãƒ³ã«é©ã—ã¦ã„ã‚‹ |
| **ä¾å­˜æ³¨å…¥** | Factory Pattern | ã‚·ãƒ³ãƒ—ãƒ«ã€ãƒ†ã‚¹ãƒˆå¯èƒ½ |
| **ã‚¨ãƒ©ãƒ¼å‡¦ç†** | AppErroråŸºåº•ã‚¯ãƒ©ã‚¹ | çµ±ä¸€æ€§ã€å‹å®‰å…¨æ€§ |
| **ãƒ†ã‚¹ãƒˆ** | Jest + RTL | React Nativeæ¨™æº– |

---

## 10. æ®µéšçš„ç§»è¡Œãƒ—ãƒ©ãƒ³è©³ç´°

### Phase 1: åŸºç›¤æ•´å‚™ï¼ˆ1-2é€±é–“ï¼‰ğŸ”´

#### ç›®æ¨™
ãƒ†ã‚¹ãƒˆå¯èƒ½ãªåŸºç›¤ã®æ§‹ç¯‰

#### ã‚¿ã‚¹ã‚¯

**1.1 DI (Dependency Injection) ãƒ‘ã‚¿ãƒ¼ãƒ³å°å…¥**

```typescript
// Before
class ChatService {
  private static instance: ChatService | null = null;
  static getInstance(): ChatService { /* ... */ }
}

// After
export interface ChatServiceDependencies {
  attachmentService: ChatAttachmentService;
  commandService: ChatCommandService;
  tokenService: ChatTokenService;
  wsManager: ChatWebSocketManager;
}

export class ChatService {
  constructor(private deps: ChatServiceDependencies) {}

  static create(deps?: Partial<ChatServiceDependencies>): ChatService {
    const defaultDeps: ChatServiceDependencies = {
      attachmentService: new ChatAttachmentService(),
      commandService: new ChatCommandService(),
      tokenService: new ChatTokenService(),
      wsManager: new ChatWebSocketManager(),
    };
    return new ChatService({ ...defaultDeps, ...deps });
  }
}

// ä½¿ç”¨
let chatServiceInstance: ChatService;

export const initializeChatService = () => {
  chatServiceInstance = ChatService.create();
};

export const getChatService = () => chatServiceInstance;

// ãƒ†ã‚¹ãƒˆ
const mockService = ChatService.create({
  attachmentService: mockAttachmentService,
});
```

**1.2 çµ±ä¸€ã•ã‚ŒãŸAppErrorä½œæˆ**

```typescript
// app/core/errors/AppError.ts
export class AppError extends Error {
  constructor(
    public readonly code: string,
    message: string,
    public readonly domain: 'file' | 'chat' | 'llm' | 'system' | 'billing',
    public readonly originalError?: unknown,
    public readonly metadata?: Record<string, any>
  ) {
    super(message);
    this.name = 'AppError';
    Object.setPrototypeOf(this, AppError.prototype);
  }
}

// app/core/errors/FileError.ts
export class FileError extends AppError {
  constructor(code: string, message: string, originalError?: unknown) {
    super(code, message, 'file', originalError);
  }
}

// app/core/errors/ChatError.ts
export class ChatError extends AppError {
  constructor(code: string, message: string, originalError?: unknown) {
    super(code, message, 'chat', originalError);
  }
}
```

**1.3 ã‚°ãƒ­ãƒ¼ãƒãƒ«ã‚¨ãƒ©ãƒ¼ãƒã‚¦ãƒ³ãƒ€ãƒªå®Ÿè£…**

```typescript
// app/shared/components/ErrorBoundary/ErrorBoundary.tsx
import React from 'react';
import { AppError } from '@core/errors';

interface Props {
  children: React.ReactNode;
}

interface State {
  hasError: boolean;
  error: AppError | null;
}

export class ErrorBoundary extends React.Component<Props, State> {
  state: State = { hasError: false, error: null };

  static getDerivedStateFromError(error: Error): State {
    const appError = error instanceof AppError
      ? error
      : new AppError('UNKNOWN_ERROR', error.message, 'system', error);

    return { hasError: true, error: appError };
  }

  componentDidCatch(error: Error, errorInfo: React.ErrorInfo) {
    logger.error('ErrorBoundary', { error, errorInfo });
  }

  render() {
    if (this.state.hasError && this.state.error) {
      return <ErrorFallback error={this.state.error} />;
    }
    return this.props.children;
  }
}

// app/App.tsx
<ErrorBoundary>
  <ThemeProvider>
    <AppContent />
  </ThemeProvider>
</ErrorBoundary>
```

#### å—ã‘å…¥ã‚Œæ¡ä»¶

- [ ] ChatServiceãŒDIãƒ‘ã‚¿ãƒ¼ãƒ³ã§å®Ÿè£…ã•ã‚Œã€ãƒ†ã‚¹ãƒˆå¯èƒ½ã«ãªã£ã¦ã„ã‚‹
- [ ] AppErrorãƒ™ãƒ¼ã‚¹ã‚¯ãƒ©ã‚¹ãŒå®Ÿè£…ã•ã‚Œã¦ã„ã‚‹
- [ ] å…¨ãƒ‰ãƒ¡ã‚¤ãƒ³ï¼ˆfile, chatç­‰ï¼‰ã§AppErrorã‚’ä½¿ç”¨ã—ã¦ã„ã‚‹
- [ ] ã‚°ãƒ­ãƒ¼ãƒãƒ«ã‚¨ãƒ©ãƒ¼ãƒã‚¦ãƒ³ãƒ€ãƒªãŒå‹•ä½œã—ã¦ã„ã‚‹
- [ ] æ—¢å­˜æ©Ÿèƒ½ãŒæ­£å¸¸ã«å‹•ä½œã—ã¦ã„ã‚‹

---

### Phase 2: çŠ¶æ…‹ç®¡ç†çµ±ä¸€ï¼ˆ2é€±é–“ï¼‰ğŸŸ 

#### ç›®æ¨™
Zustand vs Context APIã®ä½¿ã„åˆ†ã‘ã‚’æ˜ç¢ºåŒ–ã—ã€æ··åœ¨ã‚’è§£æ¶ˆ

#### ã‚¿ã‚¹ã‚¯

**2.1 ä½¿ã„åˆ†ã‘ãƒ«ãƒ¼ãƒ«ã®æ˜ç¢ºåŒ–**

```
ãƒ«ãƒ¼ãƒ«:
1. ã‚°ãƒ­ãƒ¼ãƒãƒ«çŠ¶æ…‹ï¼ˆè¤‡æ•°ç”»é¢ã§å…±æœ‰ï¼‰ â†’ Zustand
   - useChatStore
   - useSettingsStore
   - useFileListStoreï¼ˆæ–°è¦ï¼‰
   - useFileEditorStore

2. ãƒ­ãƒ¼ã‚«ãƒ«çŠ¶æ…‹ï¼ˆå˜ä¸€ã‚³ãƒ³ãƒãƒ¼ãƒãƒ³ãƒˆå†…ï¼‰ â†’ useState
   - ãƒ•ã‚©ãƒ¼ã‚«ã‚¹çŠ¶æ…‹
   - å…¥åŠ›ãƒ•ã‚©ãƒ¼ãƒ 
   - ä¸€æ™‚çš„ãªUIçŠ¶æ…‹

3. UI ãƒãƒªã‚¨ãƒ¼ã‚·ãƒ§ãƒ³/ãƒ—ãƒ­ãƒã‚¤ãƒ€ãƒ¼ â†’ Context API
   - ThemeContext
   - ChatUIContextï¼ˆUIã‚¢ãƒ‹ãƒ¡ãƒ¼ã‚·ãƒ§ãƒ³ã®ã¿ï¼‰
   - KeyboardHeightContext
```

**2.2 FlatListContext â†’ useFileListStore ç§»è¡Œ**

```typescript
// Before: screen/file-list-flat/context/FlatListContext.tsx (852è¡Œ)
const [state, dispatch] = useReducer(flatListReducer, initialState);

// After: features/file/store/fileListStore.ts
export const useFileListStore = create<FileListStore>((set, get) => ({
  // State
  files: [],
  selectedFileIds: new Set(),
  isSelectionMode: false,
  searchQuery: '',
  modals: {
    create: { visible: false },
    rename: { visible: false, file: null },
    move: { visible: false, files: [] },
  },

  // Actions
  setFiles: (files) => set({ files }),

  toggleSelectFile: (fileId) => set((state) => {
    const newSet = new Set(state.selectedFileIds);
    newSet.has(fileId) ? newSet.delete(fileId) : newSet.add(fileId);
    return { selectedFileIds: newSet };
  }),

  enterSelectionMode: () => set({ isSelectionMode: true }),
  exitSelectionMode: () => set({
    isSelectionMode: false,
    selectedFileIds: new Set()
  }),

  setSearchQuery: (query) => set({ searchQuery: query }),

  openModal: (modalName, data) => set((state) => ({
    modals: { ...state.modals, [modalName]: { visible: true, ...data } },
  })),

  closeModal: (modalName) => set((state) => ({
    modals: { ...state.modals, [modalName]: { visible: false } },
  })),

  // Async operations
  async refreshData() {
    try {
      const files = await FileRepository.getAll();
      set({ files });
    } catch (error) {
      throw new FileError('FILE_LOAD_FAILED', 'ãƒ•ã‚¡ã‚¤ãƒ«ä¸€è¦§ã®èª­ã¿è¾¼ã¿ã«å¤±æ•—ã—ã¾ã—ãŸ', error);
    }
  },

  async deleteSelectedFiles() {
    const { selectedFileIds } = get();
    try {
      await Promise.all(
        Array.from(selectedFileIds).map(id => FileRepository.delete(id))
      );
      await get().refreshData();
      set({ selectedFileIds: new Set() });
    } catch (error) {
      throw new FileError('FILE_DELETE_FAILED', 'ãƒ•ã‚¡ã‚¤ãƒ«å‰Šé™¤ã«å¤±æ•—ã—ã¾ã—ãŸ', error);
    }
  },
}));
```

**åŠ¹æœ**:
- 852è¡Œ â†’ ç´„150è¡Œã«å‰Šæ¸›
- ãƒ‡ãƒãƒƒã‚°ãƒ„ãƒ¼ãƒ«ï¼ˆZustand DevToolsï¼‰ãŒä½¿ãˆã‚‹
- å‹å®‰å…¨æ€§ã®å‘ä¸Š

#### å—ã‘å…¥ã‚Œæ¡ä»¶

- [ ] ä½¿ã„åˆ†ã‘ãƒ«ãƒ¼ãƒ«ãŒãƒ‰ã‚­ãƒ¥ãƒ¡ãƒ³ãƒˆåŒ–ã•ã‚Œã¦ã„ã‚‹
- [ ] FlatListContextãŒuseFileListStoreã«ç§»è¡Œã•ã‚Œã¦ã„ã‚‹
- [ ] å…¨ã¦ã®ç”»é¢ã§æ–°ã—ã„ã‚¹ãƒˆã‚¢ãŒå‹•ä½œã—ã¦ã„ã‚‹
- [ ] çŠ¶æ…‹ç®¡ç†ã®æ··åœ¨ãŒè§£æ¶ˆã•ã‚Œã¦ã„ã‚‹

---

### Phase 3: ChatService è²¬å‹™æ•´ç†ï¼ˆ2-3é€±é–“ï¼‰ğŸŸ¡

#### ç›®æ¨™
Orchestratorãƒ‘ã‚¿ãƒ¼ãƒ³ã§è²¬å‹™ã‚’æ˜ç¢ºåŒ–

#### ã‚¿ã‚¹ã‚¯

**3.1 ChatMessageService æŠ½å‡º**

```typescript
// features/chat/model/services/ChatMessageService.ts
export class ChatMessageService {
  constructor(private store: ChatStore) {}

  createMessage(content: string, attachments: FileFlat[]): ChatMessage {
    return {
      id: generateId(),
      content,
      timestamp: new Date(),
      attachedFiles: attachments,
      role: 'user',
    };
  }

  addMessage(message: ChatMessage): void {
    this.store.addMessage(message);
  }

  clearMessages(): void {
    this.store.clearMessages();
  }

  getMessages(): ChatMessage[] {
    return this.store.messages;
  }
}
```

**3.2 ChatService (Orchestrator)**

```typescript
// features/chat/model/services/ChatService.ts
export class ChatService {
  constructor(
    private messageService: ChatMessageService,
    private attachmentService: ChatAttachmentService,
    private commandService: ChatCommandService,
    private tokenService: ChatTokenService,
    private wsManager: ChatWebSocketManager,
    private summarizationService: ChatSummarizationService,
  ) {}

  async sendMessage(message: string): Promise<void> {
    // 1. ãƒˆãƒ¼ã‚¯ãƒ³æ®‹é«˜ãƒã‚§ãƒƒã‚¯
    await this.tokenService.checkBalance();

    // 2. æ·»ä»˜ãƒ•ã‚¡ã‚¤ãƒ«ã‚’å–å¾—
    const attachments = this.attachmentService.getAttachedFiles();

    // 3. ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸ã‚’ä½œæˆãƒ»è¿½åŠ 
    const chatMessage = this.messageService.createMessage(message, attachments);
    this.messageService.addMessage(chatMessage);

    // 4. ã‚³ãƒãƒ³ãƒ‰å®Ÿè¡Œï¼ˆå¿…è¦ã«å¿œã˜ã¦ï¼‰
    if (this.commandService.isCommand(message)) {
      await this.commandService.executeCommand(message);
      return;
    }

    // 5. LLM APIå‘¼ã³å‡ºã—
    const response = await this.apiService.sendChatMessage(message, attachments);

    // 6. ãƒˆãƒ¼ã‚¯ãƒ³ä½¿ç”¨é‡ã‚’æ›´æ–°
    this.tokenService.updateUsage(response.tokensUsed);

    // 7. ãƒ¬ã‚¹ãƒãƒ³ã‚¹ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸ã‚’è¿½åŠ 
    this.messageService.addMessage(response.message);
  }
}
```

#### å—ã‘å…¥ã‚Œæ¡ä»¶

- [ ] ChatMessageServiceãŒæŠ½å‡ºã•ã‚Œã¦ã„ã‚‹
- [ ] ChatServiceãŒOrchestratorãƒ‘ã‚¿ãƒ¼ãƒ³ã§å®Ÿè£…ã•ã‚Œã¦ã„ã‚‹
- [ ] å„ã‚µãƒ¼ãƒ“ã‚¹ã®è²¬å‹™ãŒæ˜ç¢ºã«ãªã£ã¦ã„ã‚‹
- [ ] ãƒãƒ£ãƒƒãƒˆæ©Ÿèƒ½ãŒæ­£å¸¸ã«å‹•ä½œã—ã¦ã„ã‚‹

---

### Phase 4: ãƒ‡ã‚£ãƒ¬ã‚¯ãƒˆãƒªå†æ§‹æˆï¼ˆ2-3é€±é–“ï¼‰ğŸŸ¡

#### ç›®æ¨™
FSD (Feature-Sliced Design) ã®å®Œå…¨å®Ÿè£…

#### ã‚¿ã‚¹ã‚¯

**4.1 shared/ãƒ‡ã‚£ãƒ¬ã‚¯ãƒˆãƒªä½œæˆ**

```bash
mkdir -p app/shared/{components,hooks,utils}

# ã‚³ãƒ³ãƒãƒ¼ãƒãƒ³ãƒˆç§»å‹•
mv app/components/CustomModal.tsx app/shared/components/CustomModal/
mv app/components/CustomHeader.tsx app/shared/components/CustomHeader/
# ... ä»–ã®ã‚³ãƒ³ãƒãƒ¼ãƒãƒ³ãƒˆ
```

**4.2 core/ãƒ‡ã‚£ãƒ¬ã‚¯ãƒˆãƒªä½œæˆ**

```bash
mkdir -p app/core/{errors,types,constants}

# ã‚¨ãƒ©ãƒ¼ã‚¯ãƒ©ã‚¹ã‚’ä½œæˆï¼ˆPhase 1ã§ä½œæˆæ¸ˆã¿ï¼‰
# å‹å®šç¾©ã‚’é›†ç´„
```

**4.3 features/file/ä½œæˆ**

```bash
mkdir -p app/features/file/{ui,model,store}

# screen/file-list-flat ã¨ screen/file-edit ã‚’çµ±åˆ
mv app/screen/file-list-flat/components app/features/file/ui/list
mv app/screen/file-edit/components app/features/file/ui/editor

# data/repositories ã‚‚ç§»å‹•
mv app/data/repositories app/features/file/model/repositories
```

**4.4 ãƒ‘ã‚¹ã‚¨ã‚¤ãƒªã‚¢ã‚¹è¨­å®š**

```json
// tsconfig.json
{
  "compilerOptions": {
    "baseUrl": ".",
    "paths": {
      "@core/*": ["app/core/*"],
      "@shared/*": ["app/shared/*"],
      "@features/*": ["app/features/*"],
      "@screens/*": ["app/screens/*"],
      "@data/*": ["app/data/*"],
      "@design/*": ["app/design/*"],
      "@billing/*": ["app/billing/*"],
      "@settings/*": ["app/settings/*"],
      "@navigation/*": ["app/navigation/*"]
    }
  }
}

// babel.config.js
module.exports = {
  plugins: [
    [
      'module-resolver',
      {
        root: ['./app'],
        alias: {
          '@core': './app/core',
          '@shared': './app/shared',
          '@features': './app/features',
          '@screens': './app/screens',
          '@data': './app/data',
          '@design': './app/design',
          '@billing': './app/billing',
          '@settings': './app/settings',
          '@navigation': './app/navigation',
        },
      },
    ],
  ],
};
```

**4.5 ã‚¤ãƒ³ãƒãƒ¼ãƒˆãƒ‘ã‚¹ã®æ›´æ–°**

```typescript
// Before
import { FileRepository } from '../../../../data/repositories/fileRepository';
import { logger } from '../../../utils/logger';

// After
import { FileRepository } from '@features/file/model/repositories';
import { logger } from '@shared/utils/logger';
```

#### å—ã‘å…¥ã‚Œæ¡ä»¶

- [ ] shared/, core/ãƒ‡ã‚£ãƒ¬ã‚¯ãƒˆãƒªãŒä½œæˆã•ã‚Œã¦ã„ã‚‹
- [ ] features/file/ãŒä½œæˆã•ã‚Œã€ãƒ•ã‚¡ã‚¤ãƒ«æ©Ÿèƒ½ãŒçµ±åˆã•ã‚Œã¦ã„ã‚‹
- [ ] ãƒ‘ã‚¹ã‚¨ã‚¤ãƒªã‚¢ã‚¹ãŒè¨­å®šã•ã‚Œã¦ã„ã‚‹
- [ ] å…¨ã¦ã®ã‚¤ãƒ³ãƒãƒ¼ãƒˆãƒ‘ã‚¹ãŒæ›´æ–°ã•ã‚Œã¦ã„ã‚‹
- [ ] ãƒ“ãƒ«ãƒ‰ãŒæˆåŠŸã—ã¦ã„ã‚‹
- [ ] æ—¢å­˜æ©Ÿèƒ½ãŒæ­£å¸¸ã«å‹•ä½œã—ã¦ã„ã‚‹

---

### Phase 5: ãƒ‘ãƒ•ã‚©ãƒ¼ãƒãƒ³ã‚¹æœ€é©åŒ–ï¼ˆ3é€±é–“ï¼‰ğŸŸ¢

#### ç›®æ¨™
ã‚¹ã‚±ãƒ¼ãƒ©ãƒ“ãƒªãƒ†ã‚£ã®å‘ä¸Š

#### ã‚¿ã‚¹ã‚¯

**5.1 FileRepository ã®ãƒšãƒ¼ã‚¸ãƒãƒ¼ã‚·ãƒ§ãƒ³å®Ÿè£…**

```typescript
// features/file/model/repositories/FileRepository.ts

interface GetAllOptions {
  includeContent?: boolean;  // default: true
  pageSize?: number;         // default: 50
  pageNumber?: number;       // default: 1
  maxConcurrent?: number;    // default: 3
}

static async getAll(options: GetAllOptions = {}): Promise<FileFlat[]> {
  const {
    includeContent = true,
    pageSize = 50,
    pageNumber = 1,
    maxConcurrent = 3
  } = options;

  const items = await CONTENT_DIR.list();

  // ãƒšãƒ¼ã‚¸ãƒ³ã‚°
  const start = (pageNumber - 1) * pageSize;
  const end = start + pageSize;
  const pagedItems = items.slice(start, end);

  // ä¸¦åˆ—åº¦åˆ¶å¾¡
  const results: FileFlat[] = [];
  for (let i = 0; i < pagedItems.length; i += maxConcurrent) {
    const batch = pagedItems.slice(i, i + maxConcurrent);
    const batchResults = await Promise.all(
      batch.map(async (item) => {
        const metadata = await readFileMetadata(fileDir);
        const content = includeContent
          ? await readFileContent(fileDir)
          : '';
        return metadataToFile(metadata, content);
      })
    );
    results.push(...batchResults);
  }

  return results;
}

// ä½¿ç”¨ä¾‹
// ãƒ¡ã‚¿ãƒ‡ãƒ¼ã‚¿ã®ã¿å–å¾—ï¼ˆé«˜é€Ÿï¼‰
const files = await FileRepository.getAll({
  includeContent: false,
  pageSize: 100,
  pageNumber: 1,
});
```

**5.2 åˆæœŸåŒ–ã‚¿ã‚¹ã‚¯ã®ä¸¦åˆ—åŒ–**

```typescript
// initialization/AppInitializer.ts

async initializeCriticalStage(): Promise<void> {
  // ä¾å­˜é–¢ä¿‚ã®ãªã„ã‚¿ã‚¹ã‚¯ã‚’ä¸¦åˆ—å®Ÿè¡Œ
  await Promise.all([
    this.executeTask('verifyAsyncStorage'),
    this.executeTask('initializeFileSystem'),
    this.executeTask('authenticateDevice'),
    this.executeTask('loadSettings'),
  ]);
}

async initializeServicesStage(): Promise<void> {
  // ã‚°ãƒ«ãƒ¼ãƒ—1: ä¾å­˜ãªã—ï¼ˆä¸¦åˆ—ï¼‰
  await Promise.all([
    this.executeTask('configureLLMService'),
    this.executeTask('initializeWebSocket'),
    this.executeTask('initializeBillingService'),
    this.executeTask('loadToolDefinitions'),
  ]);

  // ã‚°ãƒ«ãƒ¼ãƒ—2: ä¾å­˜ã‚ã‚Šï¼ˆä¸¦åˆ—ã€ã‚°ãƒ«ãƒ¼ãƒ—1ã®å¾Œï¼‰
  await Promise.all([
    this.executeTask('preloadLLMProviders'),
    this.executeTask('restorePendingPurchases'),
  ]);
}
```

**5.3 ä¼šè©±å±¥æ­´ã®ãƒ¡ãƒ¢ãƒªç®¡ç†**

```typescript
// features/chat/llmService/core/ConversationHistory.ts

class ConversationHistory {
  private maxHistorySize: number;

  constructor(maxHistorySize: number = 100) {
    this.maxHistorySize = maxHistorySize;
  }

  addMessage(message: ChatMessage) {
    // ãƒ•ã‚¡ã‚¤ãƒ«ã®å†…å®¹ã‚’ä¿æŒã›ãšã€å‚ç…§ã®ã¿ä¿æŒ
    const lightMessage = {
      ...message,
      attachedFiles: message.attachedFiles.map(file => ({
        id: file.id,
        name: file.name,
        // å†…å®¹ã¯ä¿æŒã—ãªã„
      })),
    };

    this.messages.push(lightMessage);

    if (this.messages.length > this.maxHistorySize) {
      this.messages.shift();
    }
  }
}
```

#### å—ã‘å…¥ã‚Œæ¡ä»¶

- [ ] FileRepository.getAll()ã«ãƒšãƒ¼ã‚¸ãƒãƒ¼ã‚·ãƒ§ãƒ³/ä¸¦åˆ—åº¦åˆ¶å¾¡ãŒå®Ÿè£…ã•ã‚Œã¦ã„ã‚‹
- [ ] åˆæœŸåŒ–ã‚¿ã‚¹ã‚¯ãŒä¸¦åˆ—åŒ–ã•ã‚Œã¦ã„ã‚‹
- [ ] èµ·å‹•æ™‚é–“ãŒæ¸¬å®šã•ã‚Œã€æ”¹å–„ãŒç¢ºèªã•ã‚Œã¦ã„ã‚‹
- [ ] ãƒ¡ãƒ¢ãƒªä½¿ç”¨é‡ãŒæ¸¬å®šã•ã‚Œã€æ”¹å–„ãŒç¢ºèªã•ã‚Œã¦ã„ã‚‹
- [ ] ãƒ‘ãƒ•ã‚©ãƒ¼ãƒãƒ³ã‚¹ãƒ†ã‚¹ãƒˆã§æ”¹å–„ãŒç¢ºèªã•ã‚Œã¦ã„ã‚‹

---

## ã¾ã¨ã‚

### ç¾çŠ¶è©•ä¾¡

**å¼·ã¿**:
- âœ… features/chatã§FSDã®åŸºç¤ãŒç¢ºç«‹
- âœ… è²¬å‹™ã®éƒ¨åˆ†çš„åˆ†é›¢ãŒæˆåŠŸ
- âœ… Zustandã«ã‚ˆã‚‹ãƒ¢ãƒ€ãƒ³ãªçŠ¶æ…‹ç®¡ç†
- âœ… å¾ªç’°ä¾å­˜ãŒæ—¢ã«è§£æ±ºæ¸ˆã¿

**èª²é¡Œ**:
- ğŸ”´ ã‚·ãƒ³ã‚°ãƒ«ãƒˆãƒ³ãƒ‘ã‚¿ãƒ¼ãƒ³ã«ã‚ˆã‚‹ãƒ†ã‚¹ãƒˆå›°é›£æ€§
- ğŸ”´ ã‚¨ãƒ©ãƒ¼ãƒãƒ³ãƒ‰ãƒªãƒ³ã‚°ã®çµ±ä¸€æ€§æ¬ å¦‚
- ğŸ”´ çŠ¶æ…‹ç®¡ç†ã®æ··åœ¨
- ğŸŸ  CustomModalã®å·¨å¤§åŒ–ï¼ˆ7,698è¡Œï¼‰
- ğŸŸ  ãƒ‘ãƒ•ã‚©ãƒ¼ãƒãƒ³ã‚¹ãƒœãƒˆãƒ«ãƒãƒƒã‚¯

### æ¨å¥¨ã‚¢ã‚¯ã‚·ãƒ§ãƒ³

1. **Phase 1ã‹ã‚‰ç€æ‰‹**ï¼ˆæœ€å„ªå…ˆï¼‰- DIå°å…¥ã€AppErrorçµ±ä¸€
2. **Phase 2ã§çŠ¶æ…‹ç®¡ç†çµ±ä¸€** - FlatListContextç§»è¡Œ
3. **Phase 3-5ã‚’é †æ¬¡å®Ÿè¡Œ** - æ®µéšçš„ãªæ”¹å–„

### æœŸå¾…åŠ¹æœ

- âœ… ãƒ†ã‚¹ãƒˆå¯èƒ½æ€§ã®å‘ä¸Šï¼ˆPhase 1ï¼‰
- âœ… ä¿å®ˆæ€§ã®å‘ä¸Šï¼ˆPhase 2-4ï¼‰
- âœ… ãƒ‘ãƒ•ã‚©ãƒ¼ãƒãƒ³ã‚¹æ”¹å–„ï¼ˆPhase 5ï¼‰
- âœ… é•·æœŸçš„ãªã‚¹ã‚±ãƒ¼ãƒ©ãƒ“ãƒªãƒ†ã‚£ç¢ºä¿

---

**ä½œæˆæ—¥**: 2025/11/16
**ä½œæˆè€…**: Claude Code
**ãƒãƒ¼ã‚¸ãƒ§ãƒ³**: 1.0
