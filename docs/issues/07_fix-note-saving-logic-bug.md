---
title: "ノート保存ロジックのバグ修正"
id: 7
status: completed
priority: high
attempt_count: 3
tags: ["bug", "persistence", "navigation", "state"]
---

## 概要 (Overview)

> 既存ノートを保存しようとすると「保存に失敗しました」というエラーが表示され、コンソールに "Non-serializable values" 警告と "Note with id ... not found" エラーが出力される問題を修正する。

## 背景 (Background)

> ローカルデータ永続化の実装 (issue #6) 後、ユーザーによるテストで新たなバグが発見された。既存ノートの編集・保存時にエラーが発生する。エラーログから、React Navigation のパラメータにシリアライズ不可能な値（コールバック関数 `onApplyDiff`）を渡していることによる警告と、`storageService` 内で存在しないIDのノートを更新しようとしているエラーが確認された。根本的な原因は、`NoteEditScreen` から `DiffViewScreen` を経由して `saveNote` アクションを呼び出す際のデータフローにあると推測される。

## 受け入れ条件 (Acceptance Criteria)

> このissueが「完了」と見なされるための具体的な条件をチェックリスト形式で記述します。
>
> - [x] 既存ノートの編集・保存時に "Non-serializable values" 警告が出力されない。
> - [x] 既存ノートを保存した際に「保存に失敗しました」エラーが表示されない。
> - [x] 既存ノートの変更が正しく永続化され、一覧画面に反映される。
> - [x] 新規ノートの作成も引き続き正常に動作する。
> - [x] 保存後、編集画面に戻り、保存された内容が表示される。

## 関連ファイル (Related Files)

> このissueに関連すると思われるファイルやディレクトリのリストです。
> LLMがコード分析を始める際のヒントになります。
>
> - `src/features/note-edit/NoteEditScreen.tsx`
> - `src/store/noteStore.ts`
> - `src/services/storageService.ts`
> - `src/features/diff-view/DiffViewScreen.tsx`
> - `src/features/note-list/NoteListScreen.tsx`

## 開発ログ (Development Log)

> このissueに関する作業の履歴を時系列で記録します。
> セッションをまたいで作業する際の引き継ぎ情報となります。

---
### 試行 #1

- **試みたこと:**
    1. "Non-serializable value" 警告と "Note not found" エラーを分析。
    2. 根本原因が、画面遷移のパラメータとしてコールバック関数を渡していることによる、不安定なデータフローにあると仮定。
    3. 画面遷移パラメータに依存せず、状態管理ストア(`noteStore`)を唯一の信頼できる情報源とするデータフローへのリファクタリングを計画。
    4. `noteStore.ts` を修正し、編集中の内容を一時的に保持する `draftNote` 状態を追加。`saveNote` アクションも `draftNote` を参照するように変更。
    5. `NoteEditScreen.tsx` と `DiffViewScreen.tsx` を修正し、新しいデータフローに適応させた。

- **結果:**
    クラッシュやエラーモーダルは解消されたが、新たに以下の問題が発生した。
    1. 保存後の画面遷移で、新しい画面がスタックに積まれてしまい、「戻る」を押すと編集画面に戻ってしまう。
    2. 保存した内容が一覧画面で即座に正しく表示されないことがある。

- **メモ:**
    `DiffViewScreen` での保存後の画面遷移処理に問題がある。`navigation.navigate()` の代わりに `navigation.reset()` を使うなど、スタックを正しく管理する必要がある。

---
### 試行 #2

- **試みたこと:**
    1. ユーザーからのフィードバックに基づき、保存後の画面遷移先をノート一覧ではなく編集画面に変更。`DiffViewScreen` の画面遷移を `navigation.goBack()` に修正。
    2. 遷移は正しくなったが、「保存してもリストに表示されない」という新たな問題が発覚。
    3. 原因を、`NoteListScreen` が別画面から戻ってきた際に再描画されず、古いリストを表示し続けているためだと断定。
    4. 解決策として、`noteStore` の `saveNote` アクションをリファクタリングし、全件再取得ではなく、メモリ上の `notes` 配列を直接更新する方式に変更した。

- **結果:**
    失敗。ユーザーからの報告によると、リストの表示問題は解決されなかった。

- **メモ:**
    `useIsFocused`フックはすでに`NoteListScreen`に存在していた。状態管理のロジックをより直接的にしたが、それでもUIが更新されない。問題はさらに根深い箇所にある可能性が高い。

---
### 試行 #3

- **試みたこと:**
    ユーザーの混乱を避けるため、一旦デバッグを中断し、現状をログに記録することにした。

- **結果:**
    複数の修正を試みたが、依然として「保存されたデータがUIに正しく反映されない」という中核的な問題が解決していない。

- **メモ:**
    問題は、`storageService`（テスト済み）、`noteStore`（複数回リファクタリング済み）、Reactコンポーネントの再描画ライフサイクルの間のどこかに存在する。これ以上の修正は、場当たり的ではなく、より根本的な原因の調査が必要。一旦作業を中断し、ユーザーの指示を待つ。

---