---
filename: B_010_folder-rename-child-visibility
id: 10
status: in-progress
priority: high # A:high | B:medium | C:low
attempt_count: 1
tags: [bug, refactoring, path-management, ui]
---

## 概要 (Overview)

フォルダの名前を変更した際に、その配下にある子フォルダや子ノートが一時的にUIから消えてしまう問題を解決する。ストレージには正しくデータが保存されているため、UIの表示ロジックとデータ更新プロセスの間に不整合があると考えられる。

## 背景 (Background)

フォルダのリनेーム機能において、以下の現象が確認されている：

- フォルダ名を変更すると、子フォルダ・子ノートがUIから表示されなくなる。
- 名前を元に戻すと、消えていたアイテムが再表示される。
- LLMにファイルリストを問い合わせると、UIに表示されていないファイルも正しく取得できる（ストレージには存在）。
- リネーム後のフォルダを移動させようとすると、挙動が不安定になる場合がある。

この問題は、データ更新とUI表示の同期、または非同期処理の取り扱いに関連している可能性がある。

## 実装方針 (Implementation Strategy)

この問題の根本原因を特定し、解決策を実装する。以下の点を考慮して調査・対応を進める：

1.  **データ更新とUI表示の同期:** フォルダリネーム時のデータ更新プロセスと、UIがそのデータを読み取り表示するタイミングの整合性を確保する。
2.  **非同期処理のハンドリング:** AsyncStorageなどの非同期ストレージ操作と、React NativeのUI状態更新の間の適切な連携を確立する。
3.  **モジュール間の責務:** 関連するサービスやコンポーネント（例: ノート操作、フォルダ操作、パス管理、UIツリー構築）の責務を再評価し、必要に応じてリファクタリングを検討する。これにより、コードの複雑性を低減し、将来的なメンテナンス性を向上させる。

## 受け入れ条件 (Acceptance Criteria)

- [ ] フォルダ名を変更しても、子フォルダ・子ノートがUIから一時的にも消えないこと。
- [ ] リネーム後のフォルダを移動させても、挙動が安定していること。
- [ ] ストレージとUIの表示が常に一致していること。
- [ ] ネストが深いフォルダ構造（3階層以上）でも正しく動作すること。
- [ ] 既存のノート・フォルダ操作機能に影響がないこと。

## 関連ファイル (Related Files)

- `app/screen/note-list/services/noteService.ts`
- `app/screen/note-list/utils/treeUtils.ts`
- `app/screen/note-list/hooks/useNoteTree.ts`
- `app/screen/note-list/noteStorage/folder.ts`
- `app/screen/note-list/noteStorage/index.ts`
- `app/services/PathService.ts`

## 制約条件 (Constraints)

- 既存のデータモデル (`Note`, `Folder` の型定義) は変更しないこと。
- AsyncStorageの非同期特性を考慮すること。
- パフォーマンスの低下を招かないこと。
- React Nativeの状態管理パターンに従うこと。

## 開発ログ (Development Log)

---
### 試行 #1 (2025-10-21)

- **試みたこと:**
  - `NoteService.updateFolder`の処理順序を変更（子要素更新 → 親フォルダ更新）
  - さらに、親フォルダと子要素を一度に更新するロジックに変更し、トランザクション的に保存

- **結果:**
  - 型チェックは通過
  - 実機テストでは改善せず、問題が継続

- **メモ:**
  - ストレージには正しくデータが保存されている（LLMが取得可能）
  - UIの`buildTree`関数が、更新中のデータを読み取っている可能性
  - `NoteService`が肥大化している

---

## AIへの申し送り事項 (Handover to AI)

- **現在の状況:**
  - フォルダリネーム時の子要素表示バグが残存している。
  - `NoteService.updateFolder`でのトランザクション的更新を試みたが、効果はなかった。
  - ストレージ上のデータは正しい。

- **次のアクション:**
  - フォルダリネーム時のデータフロー（特にストレージへの書き込み、UIへの読み込み、状態更新）を詳細に調査し、UIとストレージ間の不整合が発生するタイミングを特定する。
  - `buildTree`関数や`useNoteTree`フックなど、UI表示に関連するロジックがどのようにデータを取得・処理しているかを分析する。
  - 根本原因に基づき、適切な解決策（例: データ更新の同期メカニズム、UIの楽観的更新、サービス層の再編成など）を検討し、実装する。

- **考慮事項/ヒント:**
  - AsyncStorageの非同期処理と、React Nativeの状態更新のタイミングが問題の核心である可能性が高い。
  - データ更新中にUIが中間状態を読み取らないようにするためのメカニズムが必要かもしれない.
