# 本番デプロイチェックリスト

**最終更新**: 2025-11-21
**対象**: フロントエンド（React Native）+ バックエンド（FastAPI）

## 📋 使用方法

このチェックリストは、本番環境へのデプロイ前に必ず確認すべき項目をまとめたものです。
各項目にチェックを入れ、すべて完了してから本番デプロイを実施してください。

---

## 🔴 CRITICAL: 必須項目（すべて完了必須）

### 1. テスト

- [ ] **ユニットテストカバレッジ 80%以上**
  - [ ] フロントエンド: 認証、API Client、Stores
  - [ ] バックエンド: Services, JWT, Billing
  - [ ] 確認コマンド: `npm run test:coverage` / `pytest --cov`

- [ ] **統合テスト合格**
  - [ ] 認証フロー完了
  - [ ] 課金フロー完了
  - [ ] ファイル操作完了

- [ ] **E2Eテスト合格**
  - [ ] クリティカルパス検証済み
  - [ ] ユーザーシナリオテスト完了

- [ ] **負荷テスト実施**
  - [ ] 同時ユーザー数: 100+
  - [ ] レスポンスタイム: P95 < 500ms
  - [ ] エラーレート: < 0.1%

---

### 2. データベース

- [ ] **PostgreSQL移行完了**
  - [ ] SQLiteから移行済み
  - [ ] データ整合性検証済み
  - [ ] パフォーマンステスト合格

- [ ] **Alembic導入完了**
  - [ ] マイグレーションスクリプト作成
  - [ ] ロールバックテスト済み
  - [ ] 本番適用手順確認済み

- [ ] **バックアップ設定**
  - [ ] 自動バックアップ有効化
  - [ ] リストアテスト済み
  - [ ] バックアップ保持期間: 30日以上

- [ ] **接続プール設定**
  - [ ] POOL_SIZE設定済み
  - [ ] MAX_OVERFLOW設定済み
  - [ ] リーク検出済み

---

### 3. セキュリティ

- [ ] **OAuth CSRF保護**
  - [ ] Stateパラメータ検証実装（フロントエンド）
  - [ ] One-time use実装
  - [ ] テスト合格

- [ ] **セキュリティヘッダー**
  - [ ] HSTS有効化
  - [ ] X-Frame-Options設定
  - [ ] CSP設定
  - [ ] X-Content-Type-Options設定

- [ ] **JWT設定**
  - [ ] Secret Key 32文字以上
  - [ ] Access Token TTL: 15-30分
  - [ ] Refresh Token TTL: 30日
  - [ ] Token Blacklist稼働（Redis）

- [x] **HTTPS強制** ✅ Cloud Runが自動的に実装
  - [x] TLS 1.3使用（Cloud Runデフォルト）
  - [x] 証明書自動更新（Google管理）
  - [x] HTTPSのみ受付（HTTPポートは公開されていない）
  - [x] HSTSヘッダー実装済み（server/src/main.py:123-124）

  **注意:** Cloud Run使用時、アプリケーションレベルでのHTTPSリダイレクトミドルウェアは不要です。
  Cloud Runが自動的にHTTPS終端を処理し、HTTPリクエストは受け付けません。

- [ ] **Rate Limiting**
  - [ ] バックエンド: SlowAPI設定済み
  - [ ] フロントエンド: クライアント側throttling
  - [ ] テスト済み

- [ ] **環境変数保護**
  - [ ] Secret Managerから読み込み
  - [ ] 環境変数に秘密情報なし
  - [ ] .envファイル.gitignore済み

- [ ] **セキュリティ監査**
  - [ ] OWASP ZAP スキャン完了
  - [ ] 脆弱性ゼロ（または対応計画あり）
  - [ ] 依存関係スキャン（npm audit / safety）

---

### 4. モニタリング & ロギング

- [ ] **ログ集約**
  - [ ] GCP Cloud Logging稼働
  - [ ] 構造化ログ出力
  - [ ] ログレベル適切に設定

- [ ] **エラー追跡**
  - [ ] Sentry統合完了（フロント + バック）
  - [ ] ソースマップアップロード
  - [ ] エラーフィルタリング設定

- [ ] **メトリクス収集**
  - [ ] Prometheus統合（バックエンド）
  - [ ] カスタムメトリクス実装
  - [ ] /metricsエンドポイント保護

- [ ] **アラート設定**
  - [ ] エラーレート > 5%
  - [ ] レイテンシー > 1秒
  - [ ] CPU使用率 > 80%
  - [ ] メモリ使用率 > 85%
  - [ ] 通知先設定（Slack/Email）

- [ ] **ダッシュボード**
  - [ ] Cloud Monitoringダッシュボード作成
  - [ ] 主要メトリクス可視化
  - [ ] チーム共有済み

---

### 5. インフラストラクチャ

- [ ] **本番環境構築**
  - [ ] Cloud SQL（PostgreSQL）稼働
  - [ ] Redis稼働
  - [ ] Cloud Run / GKE デプロイ済み

- [ ] **スケーリング設定**
  - [ ] Auto-scaling有効化
  - [ ] 最小インスタンス: 2+
  - [ ] 最大インスタンス設定

- [ ] **ネットワーク設定**
  - [ ] VPC設定
  - [ ] ファイアウォールルール
  - [ ] Load Balancer設定

- [ ] **ヘルスチェック**
  - [ ] /health エンドポイント実装
  - [ ] データベース接続確認
  - [ ] Redis接続確認

---

## 🟠 HIGH: 強く推奨（可能な限り完了）

### 6. パフォーマンス最適化

- [ ] **フロントエンド**
  - [ ] バンドルサイズ分析
  - [ ] Code splitting実装
  - [ ] 画像最適化
  - [ ] キャッシュ戦略

- [ ] **バックエンド**
  - [ ] クエリ最適化
  - [ ] N+1問題解消
  - [ ] Redis キャッシング
  - [ ] 接続プール最適化

- [ ] **CDN設定**
  - [ ] 静的ファイルCDN配信
  - [ ] キャッシュTTL設定

---

### 7. CI/CD

- [ ] **自動テスト**
  - [ ] GitHub Actions設定
  - [ ] PRマージ時テスト実行
  - [ ] カバレッジレポート

- [ ] **自動デプロイ**
  - [ ] ステージング自動デプロイ
  - [ ] 本番承認フロー
  - [ ] ロールバック手順確認

- [ ] **コード品質**
  - [ ] Linter実行（Ruff, ESLint）
  - [ ] 型チェック（mypy, TypeScript）
  - [ ] フォーマッター（Black, Prettier）

---

### 8. ドキュメント

- [ ] **API ドキュメント**
  - [ ] OpenAPI / Swagger
  - [ ] エンドポイント説明
  - [ ] 認証方法記載

- [ ] **運用ドキュメント**
  - [ ] デプロイ手順
  - [ ] ロールバック手順
  - [ ] インシデント対応手順

- [ ] **アーキテクチャ図**
  - [ ] システム構成図
  - [ ] データフロー図
  - [ ] ネットワーク図

---

## 🟡 MEDIUM: 推奨（時間があれば実施）

### 9. ユーザーエクスペリエンス

- [ ] **エラーハンドリング**
  - [ ] ユーザーフレンドリーなエラーメッセージ
  - [ ] オフライン対応
  - [ ] リトライロジック

- [ ] **国際化（i18n）**
  - [ ] react-i18next導入
  - [ ] 多言語対応（日本語、英語）

- [ ] **アクセシビリティ**
  - [ ] スクリーンリーダー対応
  - [ ] キーボードナビゲーション
  - [ ] コントラスト比確認

---

### 10. ビジネスメトリクス

- [ ] **アナリティクス**
  - [ ] Firebase Analytics / Mixpanel
  - [ ] ユーザー行動追跡
  - [ ] コンバージョン追跡

- [ ] **A/Bテスト**
  - [ ] フィーチャーフラグ
  - [ ] A/Bテスト基盤

---

## 📱 フロントエンド（React Native）固有

### ビルド設定

- [ ] **本番ビルド**
  - [ ] Release buildタイプ
  - [ ] Proguard/R8有効化（Android）
  - [ ] Bitcode有効化（iOS）

- [ ] **アプリ署名**
  - [ ] Keystoreセキュア管理（Android）
  - [ ] Provisioning Profile設定（iOS）
  - [ ] Bundle ID確認

- [ ] **バージョン管理**
  - [ ] バージョンコード更新
  - [ ] セマンティックバージョニング
  - [ ] リリースノート作成

---

### ストア申請

- [ ] **Google Play**
  - [ ] ストアリスティング作成
  - [ ] スクリーンショット（5+）
  - [ ] プライバシーポリシーURL
  - [ ] アプリコンテンツレーティング

- [ ] **Apple App Store**
  - [ ] App Store Connect設定
  - [ ] スクリーンショット（各サイズ）
  - [ ] App Reviewガイドライン準拠
  - [ ] プライバシー情報

---

### プッシュ通知（実装時）

- [ ] **Firebase Cloud Messaging**
  - [ ] FCM設定
  - [ ] デバイストークン管理
  - [ ] 通知パーミッション

- [ ] **APNs**（iOS）
  - [ ] 証明書設定
  - [ ] Silent push対応

---

## 🖥️ バックエンド（FastAPI）固有

### デプロイ設定

- [ ] **Cloud Run 設定**
  - [ ] コンテナイメージビルド
  - [ ] 環境変数設定
  - [ ] メモリ割り当て: 2GB+
  - [ ] CPU割り当て: 2+
  - [ ] リクエストタイムアウト: 300s

- [ ] **データベース接続**
  - [ ] Cloud SQL Proxy設定
  - [ ] プライベートIP接続
  - [ ] SSL/TLS有効化

- [ ] **Secret Manager**
  - [ ] すべての秘密情報移行
  - [ ] IAM権限設定
  - [ ] Secret Rotation計画

---

### API設計

- [ ] **バージョニング**
  - [ ] `/api/v1/` プレフィックス
  - [ ] 後方互換性維持

- [ ] **レートリミット**
  - [ ] エンドポイント別設定
  - [ ] ユーザー別設定
  - [ ] IPベース制限

- [ ] **CORS設定**
  - [ ] 許可オリジン明示的に設定
  - [ ] ワイルドカード使用禁止
  - [ ] Preflight対応

---

## 🔍 本番前最終確認

### デプロイ直前（24時間以内）

- [ ] **全チェックリスト再確認**
- [ ] **最新のmainブランチ確認**
- [ ] **マイグレーション dry-run実行**
- [ ] **ロールバック手順確認**
- [ ] **チーム通知（デプロイ時間）**

### デプロイ中

- [ ] **段階的ロールアウト**
  - [ ] カナリアデプロイ（5%）
  - [ ] エラーレート監視
  - [ ] 段階的に50%, 100%

- [ ] **監視強化**
  - [ ] ダッシュボード監視
  - [ ] アラート確認
  - [ ] ログ監視

### デプロイ後（1時間以内）

- [ ] **スモークテスト**
  - [ ] ログイン成功
  - [ ] ファイル作成成功
  - [ ] トークン購入成功（サンドボックス）

- [ ] **メトリクス確認**
  - [ ] エラーレート正常
  - [ ] レイテンシー正常
  - [ ] ユーザー数確認

- [ ] **アラート確認**
  - [ ] 異常なアラートなし

---

## 🚨 緊急時対応

### ロールバック条件

以下のいずれかに該当する場合、即座にロールバック:

- [ ] エラーレート > 5%
- [ ] P95 レイテンシー > 3秒
- [ ] データベース接続エラー
- [ ] 重大なセキュリティ問題発見
- [ ] ユーザーからの重大なバグ報告（決済関連等）

### ロールバック手順

```bash
# バックエンド（Cloud Run）
gcloud run services update-traffic noteapp-backend \
  --to-revisions=PREVIOUS_REVISION=100

# データベース（Alembic）
alembic downgrade -1

# フロントエンド（緊急時）
# Google Play / App Store での段階的ロールアウト停止
# 前バージョンへのロールバック
```

### インシデント対応

- [ ] **Slackチャネル通知**
- [ ] **Sentryエラー確認**
- [ ] **Cloud Loggingで原因調査**
- [ ] **Post-mortem作成**

---

## 📞 連絡先

### デプロイチーム

- **エンジニアリングリード**: [Name] - [Email]
- **バックエンド担当**: [Name] - [Email]
- **フロントエンド担当**: [Name] - [Email]
- **インフラ担当**: [Name] - [Email]

### エスカレーション

- **レベル1**: エンジニアチーム
- **レベル2**: エンジニアリングマネージャー
- **レベル3**: CTO

---

## 📊 デプロイ記録

### デプロイ情報

- **日時**: ___________________
- **バージョン**: ___________________
- **担当者**: ___________________
- **レビュアー**: ___________________

### チェックリスト完了状況

- **CRITICAL項目**: _____ / 5 セクション完了
- **HIGH項目**: _____ / 3 セクション完了
- **MEDIUM項目**: _____ / 2 セクション完了

### 承認

- [ ] **エンジニアリングリード承認**
  - サイン: ___________________
  - 日付: ___________________

- [ ] **最終デプロイ承認**
  - サイン: ___________________
  - 日付: ___________________

---

## 📚 関連ドキュメント

- [総合評価レポート](./00_production-readiness-overview.md)
- [フロントエンド評価](./01_frontend-assessment.md)
- [バックエンド評価](./02_backend-assessment.md)
- [セキュリティ評価](./03_security-assessment.md)
- [テスト戦略](./04_testing-strategy.md)
- [データベース移行](./05_database-migration.md)
- [モニタリング・ロギング](./06_monitoring-logging.md)

---

## ✅ 最終確認

**すべてのCRITICAL項目が完了していることを確認しましたか？**

- [ ] はい、すべて完了しました

**本番デプロイの準備ができています。**

---

**作成日**: 2025-11-21
**バージョン**: 1.0
**次回レビュー**: デプロイ後1週間
