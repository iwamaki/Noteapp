# OAuth State Manager Redis ã‚»ãƒƒãƒˆã‚¢ãƒƒãƒ—ã‚¬ã‚¤ãƒ‰

**æœ€çµ‚æ›´æ–°**: 2025-11-18

---

> **âš ï¸ æ³¨æ„: ã“ã®ãƒ‰ã‚­ãƒ¥ãƒ¡ãƒ³ãƒˆã¯å¤ã„æƒ…å ±ã‚’å«ã‚“ã§ã„ã¾ã™**
>
> **2025å¹´11æœˆä»¥é™ã®æ–°ã—ã„æ¨å¥¨è¨­å®š:**
>
> | ç’°å¢ƒå¤‰æ•° | æ¨å¥¨å€¤ | èª¬æ˜ |
> |---------|-------|------|
> | `OAUTH_STATE_STORAGE` | **`hmac`** | HMACãƒ™ãƒ¼ã‚¹ã®ã‚¹ãƒ†ãƒ¼ãƒˆãƒ¬ã‚¹æ–¹å¼ï¼ˆRedisä¸è¦ï¼‰ |
> | `TOKEN_BLACKLIST_STORAGE` | **`postgres`** | PostgreSQLãƒ™ãƒ¼ã‚¹ã®ãƒ–ãƒ©ãƒƒã‚¯ãƒªã‚¹ãƒˆï¼ˆRedisä¸è¦ï¼‰ |
>
> **HMACãƒ™ãƒ¼ã‚¹ã®æ–¹å¼ã®ãƒ¡ãƒªãƒƒãƒˆ:**
> - Redisã®è¿½åŠ ã‚³ã‚¹ãƒˆãŒä¸è¦
> - ã‚µãƒ¼ãƒãƒ¼å´ã§çŠ¶æ…‹ã‚’ä¿æŒã—ãªã„ï¼ˆå®Œå…¨ã‚¹ãƒ†ãƒ¼ãƒˆãƒ¬ã‚¹ï¼‰
> - ãƒãƒ«ãƒã‚¤ãƒ³ã‚¹ã‚¿ãƒ³ã‚¹å¯¾å¿œ
> - ã‚»ã‚­ãƒ¥ãƒªãƒ†ã‚£é¢ã§ã‚‚å®‰å…¨ï¼ˆHMAC-SHA256ç½²åï¼‰
>
> **è©³ç´°ã¯ [DEPLOYMENT.md](./Deployment/DEPLOYMENT.md#ãƒãƒ«ãƒã‚¤ãƒ³ã‚¹ã‚¿ãƒ³ã‚¹å¯¾å¿œ) ã‚’å‚ç…§ã—ã¦ãã ã•ã„ã€‚**
>
> ä»¥ä¸‹ã¯Redisã‚’ä½¿ç”¨ã™ã‚‹å ´åˆã®ã‚»ãƒƒãƒˆã‚¢ãƒƒãƒ—ã‚¬ã‚¤ãƒ‰ã§ã™ï¼ˆã‚ªãƒ—ã‚·ãƒ§ãƒ³ï¼‰ã€‚

---

## ğŸ“‹ æ¦‚è¦

OAuth2 èªè¨¼ãƒ•ãƒ­ãƒ¼ã§ä½¿ç”¨ã•ã‚Œã‚‹ state ãƒ‘ãƒ©ãƒ¡ãƒ¼ã‚¿ã®ç®¡ç†ã‚’ã€ã‚¤ãƒ³ãƒ¡ãƒ¢ãƒªã‚¹ãƒˆãƒ¬ãƒ¼ã‚¸ã‹ã‚‰ **Redis** ã«ç§»è¡Œã™ã‚‹ãŸã‚ã®ã‚¬ã‚¤ãƒ‰ã§ã™ã€‚

### ãªãœRedisãŒå¿…è¦ã‹ï¼Ÿï¼ˆæ—§æ–¹å¼ï¼‰

ã‚¤ãƒ³ãƒ¡ãƒ¢ãƒªã‚¹ãƒˆãƒ¬ãƒ¼ã‚¸ã«ã¯ä»¥ä¸‹ã®å•é¡ŒãŒã‚ã‚Šã¾ã™ï¼š

- âŒ ãƒãƒ«ãƒã‚¤ãƒ³ã‚¹ã‚¿ãƒ³ã‚¹ç’°å¢ƒã§å‹•ä½œä¸å¯
- âŒ ã‚µãƒ¼ãƒãƒ¼å†èµ·å‹•ã§å…¨Stateæ¶ˆå¤±
- âŒ ãƒ­ãƒ¼ãƒ‰ãƒãƒ©ãƒ³ã‚µãƒ¼é…ä¸‹ã§100%å¤±æ•—
- âŒ æœ¬ç•ªç’°å¢ƒã§ã¯ä½¿ç”¨ä¸å¯

Redisã‚’ä½¿ç”¨ã™ã‚‹ã“ã¨ã§ã€ã“ã‚Œã‚‰ã®å•é¡Œã‚’è§£æ±ºã§ãã¾ã™ã€‚

**æ³¨æ„:** ç¾åœ¨ã¯ **HMACãƒ™ãƒ¼ã‚¹ã®ã‚¹ãƒ†ãƒ¼ãƒˆãƒ¬ã‚¹æ–¹å¼** ãŒæ¨å¥¨ã•ã‚Œã¾ã™ã€‚Redisã®ã‚»ãƒƒãƒˆã‚¢ãƒƒãƒ—ã¯ä¸è¦ã§ã™ã€‚

---

## ğŸ—ï¸ ã‚¢ãƒ¼ã‚­ãƒ†ã‚¯ãƒãƒ£

### ç’°å¢ƒåˆ¥ã®æ¨å¥¨æ§‹æˆ

| ç’°å¢ƒ | ã‚¹ãƒˆãƒ¬ãƒ¼ã‚¸ã‚¿ã‚¤ãƒ— | ç†ç”± |
|------|-----------------|------|
| **é–‹ç™ºç’°å¢ƒ** | `redis` âœ… | **æœ¬ç•ªç’°å¢ƒã¨ã®å®Œå…¨ãªåŒç­‰æ€§ç¢ºä¿** |
| **ã‚¹ãƒ†ãƒ¼ã‚¸ãƒ³ã‚°** | `redis` âœ… | æœ¬ç•ªç’°å¢ƒã¨åŒã˜æ§‹æˆã§ãƒ†ã‚¹ãƒˆ |
| **æœ¬ç•ªç’°å¢ƒ** | `redis` âœ… | ãƒãƒ«ãƒã‚¤ãƒ³ã‚¹ã‚¿ãƒ³ã‚¹å¯¾å¿œå¿…é ˆ |

**é‡è¦:** é–‹ç™ºç’°å¢ƒã§ã‚‚ Redis ã‚’ä½¿ç”¨ã™ã‚‹ã“ã¨ã‚’å¼·ãæ¨å¥¨ã—ã¾ã™ã€‚Docker Compose ã‚’ä½¿ç”¨ã™ã‚Œã°è¿½åŠ ã®ã‚»ãƒƒãƒˆã‚¢ãƒƒãƒ—ã¯ä¸è¦ã§ã€æœ¬ç•ªç’°å¢ƒã¨ã®å·®ç•°ã‚’ç„¡ãã™ã“ã¨ãŒã§ãã¾ã™ã€‚

### Redisæ¥ç¶šãƒ•ãƒ­ãƒ¼

```
[ã‚¯ãƒ©ã‚¤ã‚¢ãƒ³ãƒˆ]
    â†“ 1. POST /api/auth/google/auth-start
[FastAPI ã‚µãƒ¼ãƒãƒ¼]
    â†“ 2. generate_state(device_id)
[RedisStateManager]
    â†“ 3. SETEX oauth_state:{state} 300 {data}
[Redis Server]
    â†“ 4. 5åˆ†å¾Œã«è‡ªå‹•å‰Šé™¤
```

---

## ğŸš€ ã‚»ãƒƒãƒˆã‚¢ãƒƒãƒ—æ‰‹é †

### 1. Redis ãƒ‘ãƒƒã‚±ãƒ¼ã‚¸ã®ã‚¤ãƒ³ã‚¹ãƒˆãƒ¼ãƒ«

```bash
cd server
pip install -r requirements.txt
```

ã“ã‚Œã«ã‚ˆã‚Š `redis==5.0.1` ãŒã‚¤ãƒ³ã‚¹ãƒˆãƒ¼ãƒ«ã•ã‚Œã¾ã™ã€‚

### 2. Redisã‚µãƒ¼ãƒãƒ¼ã®èµ·å‹•

#### é–‹ç™ºç’°å¢ƒï¼ˆDocker Compose - æ¨å¥¨ï¼‰

**æœ€ã‚‚ç°¡å˜ãªæ–¹æ³•ã§ã™ã€‚** `docker-compose.yml` ã« Redis ã‚µãƒ¼ãƒ“ã‚¹ãŒå«ã¾ã‚Œã¦ã„ã‚‹ãŸã‚ã€è¿½åŠ ã®ã‚»ãƒƒãƒˆã‚¢ãƒƒãƒ—ã¯ä¸è¦ã§ã™ã€‚

```bash
cd server
docker compose up --build

# åˆ¥ã®ã‚¿ãƒ¼ãƒŸãƒŠãƒ«ã§æ¥ç¶šç¢ºèª
docker compose exec redis redis-cli ping
# æœŸå¾…ã•ã‚Œã‚‹å‡ºåŠ›: PONG
```

#### ãƒ­ãƒ¼ã‚«ãƒ«é–‹ç™ºç’°å¢ƒï¼ˆDockerã‚¹ã‚¿ãƒ³ãƒ‰ã‚¢ãƒ­ãƒ³ï¼‰

```bash
# Redis ã‚³ãƒ³ãƒ†ãƒŠã‚’èµ·å‹•
docker run -d \
  --name redis-oauth \
  -p 6379:6379 \
  redis:7-alpine

# æ¥ç¶šç¢ºèª
docker exec -it redis-oauth redis-cli ping
# æœŸå¾…ã•ã‚Œã‚‹å‡ºåŠ›: PONG
```

#### ãƒ­ãƒ¼ã‚«ãƒ«é–‹ç™ºç’°å¢ƒï¼ˆmacOS Homebrewï¼‰

```bash
brew install redis
brew services start redis
```

#### æœ¬ç•ªç’°å¢ƒï¼ˆGCP Cloud Memorystoreï¼‰

1. GCP ã‚³ãƒ³ã‚½ãƒ¼ãƒ«ã§ Cloud Memorystore ã‚¤ãƒ³ã‚¹ã‚¿ãƒ³ã‚¹ã‚’ä½œæˆ
2. VPC ãƒãƒƒãƒˆãƒ¯ãƒ¼ã‚¯ã‚’è¨­å®š
3. æ¥ç¶šã‚¨ãƒ³ãƒ‰ãƒã‚¤ãƒ³ãƒˆï¼ˆä¾‹: `10.0.0.3:6379`ï¼‰ã‚’ãƒ¡ãƒ¢

### 3. ç’°å¢ƒå¤‰æ•°ã®è¨­å®š

#### é–‹ç™ºç’°å¢ƒï¼ˆ`.env.development`ï¼‰

```bash
# OAuth State ç®¡ç†è¨­å®š
# é–‹ç™ºç’°å¢ƒã§ã‚‚Redisã‚’ä½¿ç”¨ï¼ˆæœ¬ç•ªç’°å¢ƒã¨ã®åŒç­‰æ€§ç¢ºä¿ï¼‰
OAUTH_STATE_STORAGE=redis

# Redis æ¥ç¶š URLï¼ˆDocker Composeä½¿ç”¨æ™‚ï¼‰
REDIS_URL=redis://redis:6379/0
```

**æ³¨æ„:** Docker Compose ã‚’ä½¿ç”¨ã™ã‚‹å ´åˆã€ãƒ›ã‚¹ãƒˆåã¯ `redis` ã§ã™ï¼ˆ`localhost` ã§ã¯ã‚ã‚Šã¾ã›ã‚“ï¼‰ã€‚

#### æœ¬ç•ªç’°å¢ƒï¼ˆ`.env.production`ï¼‰

```bash
# OAuth State ç®¡ç†è¨­å®šï¼ˆæœ¬ç•ªç’°å¢ƒã§ã¯å¿…é ˆï¼‰
OAUTH_STATE_STORAGE=redis
REDIS_URL=redis://10.0.0.3:6379/0
```

### 4. ã‚¢ãƒ—ãƒªã‚±ãƒ¼ã‚·ãƒ§ãƒ³ã®èµ·å‹•

```bash
cd server
uvicorn src.main:app --reload
```

èµ·å‹•ãƒ­ã‚°ã§ä½¿ç”¨ã•ã‚Œã¦ã„ã‚‹ã‚¹ãƒˆãƒ¬ãƒ¼ã‚¸ã‚’ç¢ºèªï¼š

```
INFO:     Initializing RedisStateManager...
INFO:     Redis connection established: redis://localhost:6379/0
```

ã¾ãŸã¯

```
INFO:     Initializing OAuthStateManager (in-memory)...
```

---

## ğŸ§ª å‹•ä½œç¢ºèª

### 1. State ç”Ÿæˆã®ãƒ†ã‚¹ãƒˆ

```bash
# OAuthèªè¨¼é–‹å§‹ã‚¨ãƒ³ãƒ‰ãƒã‚¤ãƒ³ãƒˆã‚’ãƒ†ã‚¹ãƒˆ
curl -X POST http://localhost:8000/api/auth/google/auth-start \
  -H "Content-Type: application/json" \
  -d '{"device_id": "550e8400-e29b-41d4-a716-446655440000"}'
```

**æœŸå¾…ã•ã‚Œã‚‹å¿œç­”:**

```json
{
  "auth_url": "https://accounts.google.com/o/oauth2/v2/auth?...",
  "state": "ãƒ©ãƒ³ãƒ€ãƒ ãªæ–‡å­—åˆ—"
}
```

### 2. Redisã«ãƒ‡ãƒ¼ã‚¿ãŒä¿å­˜ã•ã‚Œã¦ã„ã‚‹ã‹ç¢ºèª

```bash
# Dockerã®å ´åˆ
docker exec -it redis-oauth redis-cli

# Redis CLIã§å®Ÿè¡Œ
127.0.0.1:6379> KEYS oauth_state:*
1) "oauth_state:xxxxxxxxxxxxxxxxxxxxx"

127.0.0.1:6379> GET oauth_state:xxxxxxxxxxxxxxxxxxxxx
"{\"device_id\":\"550e8400-e29b-41d4-a716-446655440000\",\"created_at\":1700000000.0,\"expires_at\":1700000300.0}"

# TTLç¢ºèªï¼ˆæ®‹ã‚Šæ™‚é–“ï¼‰
127.0.0.1:6379> TTL oauth_state:xxxxxxxxxxxxxxxxxxxxx
(integer) 295
```

### 3. State æ¤œè¨¼ã®ãƒ†ã‚¹ãƒˆ

å®Ÿéš›ã®OAuthèªè¨¼ãƒ•ãƒ­ãƒ¼ã‚’å®Ÿè¡Œã—ã¦ã€ã‚³ãƒ¼ãƒ«ãƒãƒƒã‚¯ã‚¨ãƒ³ãƒ‰ãƒã‚¤ãƒ³ãƒˆã§StateãŒæ­£ã—ãæ¤œè¨¼ã•ã‚Œã‚‹ã“ã¨ã‚’ç¢ºèªã—ã¾ã™ã€‚

---

## ğŸ“Š çµ±è¨ˆæƒ…å ±ã®å–å¾—

State Managerã®çµ±è¨ˆæƒ…å ±ã‚’ç¢ºèªã§ãã¾ã™ï¼š

```python
from src.auth.oauth_state_manager import get_state_manager

state_manager = get_state_manager()
stats = state_manager.get_stats()
print(stats)
# {"active_states": 3, "ttl_seconds": 300}
```

---

## ğŸ”§ ãƒˆãƒ©ãƒ–ãƒ«ã‚·ãƒ¥ãƒ¼ãƒ†ã‚£ãƒ³ã‚°

### Redisæ¥ç¶šã‚¨ãƒ©ãƒ¼

**ç—‡çŠ¶:**

```
ERROR:    Failed to connect to Redis: Error 111 connecting to localhost:6379. Connection refused.
WARNING:  Falling back to in-memory OAuthStateManager
```

**åŸå› ã¨å¯¾å‡¦æ³•:**

1. Redisã‚µãƒ¼ãƒãƒ¼ãŒèµ·å‹•ã—ã¦ã„ãªã„
   ```bash
   docker ps | grep redis  # Dockerã®å ´åˆ
   brew services list | grep redis  # Homebrewã®å ´åˆ
   ```

2. æ¥ç¶šURLãŒé–“é•ã£ã¦ã„ã‚‹
   - `REDIS_URL` ç’°å¢ƒå¤‰æ•°ã‚’ç¢ºèª
   - ãƒ›ã‚¹ãƒˆåã€ãƒãƒ¼ãƒˆç•ªå·ãŒæ­£ã—ã„ã‹ç¢ºèª

3. ãƒãƒƒãƒˆãƒ¯ãƒ¼ã‚¯ã®å•é¡Œ
   ```bash
   # æ¥ç¶šãƒ†ã‚¹ãƒˆ
   telnet localhost 6379
   ```

### Redisãƒ‘ãƒƒã‚±ãƒ¼ã‚¸ãŒè¦‹ã¤ã‹ã‚‰ãªã„

**ç—‡çŠ¶:**

```
ImportError: redis package is required for RedisStateManager.
```

**å¯¾å‡¦æ³•:**

```bash
pip install redis==5.0.1
```

### State ãŒè¦‹ã¤ã‹ã‚‰ãªã„ã‚¨ãƒ©ãƒ¼

**ç—‡çŠ¶:**

```
WARNING:  OAuth state not found (Redis): state=xxxxxxxxxx...
```

**åŸå› :**

- State ã®æœ‰åŠ¹æœŸé™åˆ‡ã‚Œï¼ˆ5åˆ†ï¼‰
- åˆ¥ã®Redisã‚¤ãƒ³ã‚¹ã‚¿ãƒ³ã‚¹ã‚’å‚ç…§ã—ã¦ã„ã‚‹
- RedisãŒå†èµ·å‹•ã•ã‚Œã¦ãƒ‡ãƒ¼ã‚¿ãŒæ¶ˆå¤±

**å¯¾å‡¦æ³•:**

1. OAuthèªè¨¼ãƒ•ãƒ­ãƒ¼ã‚’æœ€åˆã‹ã‚‰ã‚„ã‚Šç›´ã™
2. Redisã®æ°¸ç¶šåŒ–è¨­å®šã‚’ç¢ºèªï¼ˆæœ¬ç•ªç’°å¢ƒã®å ´åˆï¼‰

---

## ğŸ” ã‚»ã‚­ãƒ¥ãƒªãƒ†ã‚£è€ƒæ…®äº‹é …

### State ãƒ‘ãƒ©ãƒ¡ãƒ¼ã‚¿ã®ç‰¹æ€§

- âœ… æš—å·å­¦çš„ã«å®‰å…¨ãªãƒ©ãƒ³ãƒ€ãƒ æ–‡å­—åˆ—ï¼ˆ`secrets.token_urlsafe(32)`ï¼‰
- âœ… ãƒ¯ãƒ³ã‚¿ã‚¤ãƒ ä½¿ç”¨ï¼ˆæ¤œè¨¼å¾Œå³åº§ã«å‰Šé™¤ï¼‰
- âœ… æœ‰åŠ¹æœŸé™5åˆ†ï¼ˆTTL: 300ç§’ï¼‰
- âœ… CSRFæ”»æ’ƒå¯¾ç­–

### Redisæ¥ç¶šã®ã‚»ã‚­ãƒ¥ãƒªãƒ†ã‚£

**æœ¬ç•ªç’°å¢ƒã§ã¯ä»¥ä¸‹ã‚’æ¨å¥¨:**

1. **TLS/SSLæ¥ç¶š**
   ```bash
   REDIS_URL=rediss://your-host:6380/0  # rediss:// (sãŒ2ã¤)
   ```

2. **ãƒ‘ã‚¹ãƒ¯ãƒ¼ãƒ‰èªè¨¼**
   ```bash
   REDIS_URL=redis://username:password@your-host:6379/0
   ```

3. **VPCãƒ—ãƒ©ã‚¤ãƒ™ãƒ¼ãƒˆãƒãƒƒãƒˆãƒ¯ãƒ¼ã‚¯**
   - ã‚¤ãƒ³ã‚¿ãƒ¼ãƒãƒƒãƒˆã«å…¬é–‹ã—ãªã„
   - ãƒ•ã‚¡ã‚¤ã‚¢ã‚¦ã‚©ãƒ¼ãƒ«ã§æ¥ç¶šå…ƒã‚’åˆ¶é™

---

## ğŸ“ˆ ãƒ‘ãƒ•ã‚©ãƒ¼ãƒãƒ³ã‚¹

### ãƒ™ãƒ³ãƒãƒãƒ¼ã‚¯ï¼ˆå‚è€ƒå€¤ï¼‰

| æ“ä½œ | ã‚¤ãƒ³ãƒ¡ãƒ¢ãƒª | Redisï¼ˆãƒ­ãƒ¼ã‚«ãƒ«ï¼‰ | Redisï¼ˆãƒªãƒ¢ãƒ¼ãƒˆï¼‰ |
|------|-----------|-----------------|-----------------|
| generate_state | ~0.1ms | ~1ms | ~5ms |
| verify_state | ~0.1ms | ~1ms | ~5ms |

Redisã‚’ä½¿ç”¨ã—ã¦ã‚‚ã€OAuthèªè¨¼ãƒ•ãƒ­ãƒ¼ã«å½±éŸ¿ã‚’ä¸ãˆã‚‹é…å»¶ã¯ã»ã¨ã‚“ã©ã‚ã‚Šã¾ã›ã‚“ã€‚

### ã‚¹ã‚±ãƒ¼ãƒ©ãƒ“ãƒªãƒ†ã‚£

- ã‚¤ãƒ³ãƒ¡ãƒ¢ãƒª: 1ã‚¤ãƒ³ã‚¹ã‚¿ãƒ³ã‚¹ã®ã¿
- Redis: ç„¡åˆ¶é™ã®ã‚¤ãƒ³ã‚¹ã‚¿ãƒ³ã‚¹æ•°ï¼ˆæ°´å¹³ã‚¹ã‚±ãƒ¼ãƒ«å¯èƒ½ï¼‰

---

## ğŸ”„ ãƒ•ã‚©ãƒ¼ãƒ«ãƒãƒƒã‚¯æ©Ÿæ§‹

RedisStateManager ã®åˆæœŸåŒ–ã«å¤±æ•—ã—ãŸå ´åˆã€è‡ªå‹•çš„ã«ã‚¤ãƒ³ãƒ¡ãƒ¢ãƒªã‚¹ãƒˆãƒ¬ãƒ¼ã‚¸ã«ãƒ•ã‚©ãƒ¼ãƒ«ãƒãƒƒã‚¯ã—ã¾ã™ï¼š

```python
# src/auth/oauth_state_manager.py (get_state_manageré–¢æ•°)
if storage_type == "redis":
    try:
        _state_manager = RedisStateManager(ttl_seconds=300)
    except Exception as e:
        logger.error(f"Failed to initialize RedisStateManager: {e}")
        logger.warning("Falling back to in-memory OAuthStateManager")
        _state_manager = OAuthStateManager(ttl_seconds=300)
```

ã“ã‚Œã«ã‚ˆã‚Šã€RedisãŒä¸€æ™‚çš„ã«åˆ©ç”¨ä¸å¯ã§ã‚‚ã‚¢ãƒ—ãƒªã‚±ãƒ¼ã‚·ãƒ§ãƒ³ã¯èµ·å‹•ã§ãã¾ã™ã€‚

**æ³¨æ„:** æœ¬ç•ªç’°å¢ƒã§ã¯ã€ãƒ•ã‚©ãƒ¼ãƒ«ãƒãƒƒã‚¯ãŒç™ºç”Ÿã—ã¦ã„ãªã„ã‹ç›£è¦–ãŒå¿…è¦ã§ã™ã€‚

---

## ğŸ“ ç’°å¢ƒå¤‰æ•°ãƒªãƒ•ã‚¡ãƒ¬ãƒ³ã‚¹

| ç’°å¢ƒå¤‰æ•° | å¿…é ˆ | ãƒ‡ãƒ•ã‚©ãƒ«ãƒˆ | èª¬æ˜ |
|---------|------|-----------|------|
| `OAUTH_STATE_STORAGE` | No | `memory` | ã‚¹ãƒˆãƒ¬ãƒ¼ã‚¸ã‚¿ã‚¤ãƒ—: `memory` ã¾ãŸã¯ `redis` |
| `REDIS_URL` | Conditional | `redis://localhost:6379/0` | Redisæ¥ç¶šURLï¼ˆ`OAUTH_STATE_STORAGE=redis`ã®å ´åˆå¿…é ˆï¼‰ |

---

## ğŸš€ ãƒ‡ãƒ—ãƒ­ã‚¤ãƒã‚§ãƒƒã‚¯ãƒªã‚¹ãƒˆ

æœ¬ç•ªç’°å¢ƒã«ãƒ‡ãƒ—ãƒ­ã‚¤ã™ã‚‹å‰ã«ã€ä»¥ä¸‹ã‚’ç¢ºèªã—ã¦ãã ã•ã„ï¼š

- [ ] Redis ã‚µãƒ¼ãƒãƒ¼ãŒç¨¼åƒã—ã¦ã„ã‚‹
- [ ] `OAUTH_STATE_STORAGE=redis` ãŒè¨­å®šã•ã‚Œã¦ã„ã‚‹
- [ ] `REDIS_URL` ãŒæ­£ã—ãè¨­å®šã•ã‚Œã¦ã„ã‚‹
- [ ] Redis ã¸ã®æ¥ç¶šãŒVPCãƒ—ãƒ©ã‚¤ãƒ™ãƒ¼ãƒˆãƒãƒƒãƒˆãƒ¯ãƒ¼ã‚¯çµŒç”±
- [ ] Redisã«ãƒ‘ã‚¹ãƒ¯ãƒ¼ãƒ‰èªè¨¼ã¾ãŸã¯TLSæ¥ç¶šãŒè¨­å®šã•ã‚Œã¦ã„ã‚‹
- [ ] ã‚¢ãƒ—ãƒªã‚±ãƒ¼ã‚·ãƒ§ãƒ³èµ·å‹•æ™‚ã« "Initializing RedisStateManager..." ãƒ­ã‚°ãŒå‡ºã¦ã„ã‚‹
- [ ] OAuthèªè¨¼ãƒ•ãƒ­ãƒ¼ãŒæ­£å¸¸ã«å‹•ä½œã™ã‚‹ã“ã¨ã‚’ç¢ºèªæ¸ˆã¿

---

## ğŸ“š é–¢é€£ãƒ‰ã‚­ãƒ¥ãƒ¡ãƒ³ãƒˆ

- [OAuth2 Authorization Code Flow å®Ÿè£…ã‚¬ã‚¤ãƒ‰](./OAUTH2_AUTHORIZATION_CODE_FLOW.md)ï¼ˆæœªä½œæˆã®å ´åˆã¯çœç•¥å¯ï¼‰
- [JWTèªè¨¼ã‚»ãƒƒãƒˆã‚¢ãƒƒãƒ—ã‚¬ã‚¤ãƒ‰](./JWT_SECRET_SETUP.md)
- [Rediså…¬å¼ãƒ‰ã‚­ãƒ¥ãƒ¡ãƒ³ãƒˆ](https://redis.io/docs/)
- [GCP Cloud Memorystore](https://cloud.google.com/memorystore/docs/redis)

---

**æ¬¡ã®ã‚¹ãƒ†ãƒƒãƒ—:**

Redisç§»è¡ŒãŒå®Œäº†ã—ãŸã‚‰ã€`docs/issues/20251118_auth_api_infrastructure_analysis.md` ã®ãƒã‚§ãƒƒã‚¯ãƒªã‚¹ãƒˆã‚’æ›´æ–°ã—ã¦ãã ã•ã„ã€‚

```markdown
- [x] **#2** OAuth State Managerã®Redisç§»è¡Œ
  - [x] Redisæ¥ç¶šè¨­å®šè¿½åŠ 
  - [x] RedisStateManager ã‚¯ãƒ©ã‚¹å®Ÿè£…
  - [x] ã‚¤ãƒ³ãƒ¡ãƒ¢ãƒªå®Ÿè£…ã¨ã®äº’æ›æ€§ç¢ºä¿
  - [x] ç’°å¢ƒå¤‰æ•°ã§ã‚¹ãƒˆãƒ¬ãƒ¼ã‚¸åˆ‡ã‚Šæ›¿ãˆå¯èƒ½ã«
  - [ ] ãƒ­ãƒ¼ã‚«ãƒ«é–‹ç™ºç’°å¢ƒã§ã®Redisèµ·å‹•ç¢ºèª
  - [ ] æœ¬ç•ªç’°å¢ƒã¸ã®ãƒ‡ãƒ—ãƒ­ã‚¤ã¨å‹•ä½œç¢ºèª
```
